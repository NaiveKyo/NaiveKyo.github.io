<!DOCTYPE HTML>
<html lang="zh_CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Redis,Database,Cache">
    <meta name="description" content="This is a blog in order to record my learning and growth.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Redis_Intro | Miló&amp;Akoúo̱</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Miló&Akoúo̱" type="application/atom+xml">
</head>


<!-- 加载动画 -->

    <style type="text/css" lang="css">
  #loading-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9998;
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  #loading-left {
    width: 50%;
    height: 100%;
    background-color: #ddd;
    display: inline-block;
    background-image: url("https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/medias/loading.gif");
    background-size: cover;
    background-repeat: no-repeat;
    transition: margin-right 1.5s;
  }

  #loading-right {
    width: 50%;
    height: 100%;
    background-color: #ddd;
    display: inline-block;
    background-image: url("https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/medias/loading.gif");
    background-size: cover;
    background-repeat: no-repeat;
  }

  /* 太极特效 */
  @keyframes rotate {
      from {
          transform: rotate(0deg)
      }

      to {
          transform: rotate(359deg)
      }
  }

  div[class="loading-image"] {
    margin: 0 auto;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 1px solid #ddd;
    z-index: 9999;
    background-image:
        radial-gradient(50% 50% at 50% 25%, #000 10%, transparent 0),
        radial-gradient(50% 50% at 50% 75%, #fff 10%, transparent 0),
        radial-gradient(50% 50% at 50% 25%, #fff 50%, transparent 0), radial-gradient(50% 50% at 50% 75%, #000 50%, transparent 0),
        linear-gradient(to left, #fff 50%, #000 50%);
    animation: rotate 3s linear infinite;
  }

  .loading-text {
    margin-bottom: 1vh;
    text-align: center;
    font-size: 3rem;
    /* box-sizing: border-box; */
    z-index: 9999;
    padding: 0 10px;
    height: 90px;
    line-height: 90px;
    font-weight: bold;
    font-family: cursive;
    background: linear-gradient(to right, #59c229, #f5287ded);
    -webkit-text-fill-color: transparent;
    -webkit-background-clip: text
  }

  #show {
    /* 加载图片和文字屏幕居中 */
    /* width: 400px; */
    /* height: 400px; */
    background-color: transparent;
    position: fixed;
    /* left: 561px; */
    /* top: 211px; */
  }

  /*中等屏幕下(平板类)的样式*/
  @media only screen and (min-width: 600px) and (max-width: 992px) {
      .container {
        width: 90%;
      }
      #show {
        display: none;
      }
  }

  @media only screen and (min-width: 1000px) and (max-width: 1024px) {
      .container {
        width: 90%;
      }
      #show {
        display: none;
      }
  }

  /* 小型设备 */
  @media only screen and (max-width: 601) {
    .loading-text {
      font-size: 1.5rem;
    }
    #show {
      display: none;
    }
  }

  /* .fadeout_left {
    opacity: 0; 
    filter: alpha(opacity=0);
  } */

</style>

<script>

            
  // window.onload = function() {
  //   const loader = document.getElementById("loading-container");

  //   if (sessionStorage.getItem('flag') == null) {
  //     console.log("111111")
  //     const loaded = function() {
  //       setTimeout(function() {
  //         loader.style.display = 'none'
  //       }, 1000)
  //     }
  //     loaded();
  //     sessionStorage.setItem('flag', 1)
  //   } else {
  //     loader.style.display = 'none'
  //   }
  // }

 
  (function () {
      
      const loaded = function() {
        setTimeout(function() {
            const loader = document.getElementById("loading-container");
            const load_left = document.getElementById("loading-left");
            const load_right = document.getElementById("loading-right");
            load_left.style.marginRight = "100%"

            // 设置动画的显示时间
            setTimeout(function() {
              loader.style.display="none";
            }, 1500)
          }, 300); 
      }
      loaded()
  })() 
</script>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/img/20220215213943.png);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<!-- <script type="text/javascript">
	var OriginTitile=document.title,st;
	document.addEventListener("visibilitychange",function(){
			document.hidden?(document.title="Σ(っ °Д °;)っ喔哟，不见了哦！",
			clearTimeout(st)):(document.title="(๑•̀ㅂ•́) ✧被发现了～",st=setTimeout(function(){document.title=OriginTitile},3e3))
		}
	)
</script> -->

<body>
    <!-- 加载动画 -->
	
		<div id="loading-container">
            <div id="loading-left"></div>
            <div id="loading-right"></div>
            <div id="show">
                <p class="loading-text">少女祈祷中</p>
                <div class="loading-image"></div>
            </div>
		</div>
	

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/img/20220215211225.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Miló&amp;Akoúo̱</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/series" class="waves-effect waves-light">
      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Series</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/img/20220215211225.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Miló&amp;Akoúo̱</div>
        <div class="logo-desc">
            
            This is a blog in order to record my learning and growth.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/series" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-list"></i>
			
			Series
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="http://github.com/NaiveKyo" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="http://github.com/NaiveKyo" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/medias/featureimages/2.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Redis_Intro</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
		/* 简陋的滚动条 */
		height: calc(100vh - 250px);
		overflow: scroll; 
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Redis/">
                                <span class="chip bg-color">Redis</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Redis/" class="post-category">
                                Redis
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-07-07
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2021-08-29
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    19.1k
                </div>
                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Redis-Introduction"><a href="#Redis-Introduction" class="headerlink" title="Redis Introduction"></a>Redis Introduction</h1><h2 id="一、NoSQL-概述"><a href="#一、NoSQL-概述" class="headerlink" title="一、NoSQL 概述"></a>一、NoSQL 概述</h2><h3 id="1、为什么要用-NoSQL"><a href="#1、为什么要用-NoSQL" class="headerlink" title="1、为什么要用 NoSQL"></a>1、为什么要用 NoSQL</h3><p>大数据时代：</p>
<p>一般的数据库无法处理大数据，2006 年 Hadoop 发布</p>
<ul>
<li>单机 Mysql <ul>
<li>App ==》DAL ==》Mysql</li>
<li>这种情况下，网站的瓶颈：<ul>
<li>数据量如果太大，一个机器不能满足需求</li>
<li>数据量查过 300w 就需要使用索引了（B+ Tree），一个机器内存也放不下</li>
<li>访问量（读写混合）一个服务器无法承担</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Memcached（缓存）+ MySQL + 垂直拆分（读写分离）<ul>
<li>读写分离：将数据库按照功能进行分类，不同 MySQL 数据库的功能不一样</li>
<li>问题：如何保证数据库一致性，以及数据库查询效率</li>
<li>使用缓存，同时不同的 MySQL 数据库需要同步</li>
<li>App ==&gt; DAL ==&gt; Cache ==&gt; MySQL 1 2 3</li>
<li>发展过程：优化数据结构和索引（底层）==&gt; 文件缓存（IO）–&gt; Memcached</li>
</ul>
</li>
</ul>
<ul>
<li>分库分表 + 水平拆分 + MySQL 集群<ul>
<li>App –&gt; DAL –&gt; 集群1 集群 2 3 4</li>
<li>本质：数据库（读、写），缓存解决大部分读的问题，分库分表解决大部分写的问题</li>
<li>早些年 MyISAM：表锁，十分影响效率，高并发会产生严重问题</li>
<li>现在 Innodb：行锁</li>
<li>慢慢的开始使用<code>分库分表</code>解决写的压力</li>
<li>MySQL 提出表分区（基本不使用了）、MySQL 的集群（很好满足了那个年代的大部分需求）</li>
</ul>
</li>
</ul>
<ul>
<li>最近的年代<ul>
<li>MySQL 等关系型数据库不够用了，数据量很多，变化很快</li>
<li>图数据库、json（BSON）</li>
<li>使用 MySQL 的时候使用它存一些比较大的文件、图、博客文章等等，数据库很大，效率会变低，我们应该使用特定的数据库来处理这些数据，MySQL 的压力就会变小</li>
</ul>
</li>
</ul>
<p><strong>目前基本的互联网项目：</strong></p>
<p><img src="https://naivekyo.oss-cn-hangzhou.aliyuncs.com/blog%27image/test.png"></p>
<blockquote>
<p>为什么要用 NoSQL</p>
</blockquote>
<p>用户个人信息，社交网络，地理位置，用户产生的数据，用户日志爆发式增长</p>
<p>NoSQL 数据库，可以很好的处理上述情况</p>
<h3 id="2、什么是-NoSQL"><a href="#2、什么是-NoSQL" class="headerlink" title="2、什么是 NoSQL"></a>2、什么是 NoSQL</h3><blockquote>
<p>NoSQL</p>
</blockquote>
<p>NoSQL = Not Only SQL</p>
<p>泛指非关系型数据库</p>
<p>很多数据类型的存储不需要固定格式（关系型格式固定），不需要多余的操作就可以横向扩展（Map&lt;String, Object&gt;）, Redis 使用 键值对 存储</p>
<blockquote>
<p>NoSQL 特点</p>
</blockquote>
<p>1、方便扩展（数据之间没有关系）</p>
<p>2、大数据量，高性能（Redis 一秒写 8 万次，读取 11 万次，NoSQL 的缓存记录级，是一种细粒度的缓存，性能会比较高）</p>
<p>3、数据类型是多样的 （<code>不需要事先设计数据库</code> 随取随用，如果是数据量非常大的数据库，很难设计）</p>
<p>4、传统 RDBMS 和 NoSQL</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">传统的 RDBMS
<span class="token punctuation">-</span> 结构化阻止
<span class="token punctuation">-</span> SQL
<span class="token punctuation">-</span> 数据和关系都存在单独的表中
<span class="token punctuation">-</span> 操作语言，数据定义
<span class="token punctuation">-</span> 严格的一致性（ACID）
<span class="token punctuation">-</span> 基础的事务
<span class="token punctuation">-</span> <span class="token punctuation">...</span><span class="token punctuation">...</span><span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">NoSQL
<span class="token punctuation">-</span> 不仅仅是数据
<span class="token punctuation">-</span> 没有固定的查询语言
<span class="token punctuation">-</span> 键值对，列存储、文档存储、图形数据库（社交关系等等）
<span class="token punctuation">-</span> 最终一致性
<span class="token punctuation">-</span> CAP 定义 和 BASE （异地多活）
<span class="token punctuation">-</span> 高性能，高可用，高扩展性
<span class="token punctuation">-</span> <span class="token punctuation">...</span><span class="token punctuation">...</span>..<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>了解 ：3V + 3高</p>
</blockquote>
<p>大数据时代的 3 V：主要是描述问题</p>
<ol>
<li>海量 Volume</li>
<li>多样 Variety</li>
<li>实时 Velocity</li>
</ol>
<p>大数据时代的 3 高：主要是对程序的要求</p>
<ol>
<li>高并发</li>
<li>高可拓 </li>
<li>高性能</li>
</ol>
<p>真正在公司中的实践：NoSQL + RDBMS 结合使用</p>
<h3 id="3、阿里巴巴架构演进"><a href="#3、阿里巴巴架构演进" class="headerlink" title="3、阿里巴巴架构演进"></a>3、阿里巴巴架构演进</h3><p>敏捷开发、极限编程</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">1、商品基本信息
	名称、价格、商品信息
	关系型数据库就可以解决了
	
2、商品的描述、评论（文字比较多）
	文档型数据库：MongoDB
	
3、图片
	分布式文件系统 FastDFS
	<span class="token punctuation">-</span> 淘宝自己的 TFS
	<span class="token punctuation">-</span> Google 的 GFS
	<span class="token punctuation">-</span> Hadoop HDFS
	<span class="token punctuation">-</span> 阿里云的 OSS
	
4、商品关键字（搜索）
	<span class="token punctuation">-</span> 搜索引擎 solr elasticsearch
	<span class="token punctuation">-</span> 淘宝 ISerach
	
	
5、商品热门波段信息
	<span class="token punctuation">-</span> 内存数据库
	<span class="token punctuation">-</span> redis、tair、memcache。。。。
	
6、商品交易，外部的支付接口
	<span class="token punctuation">-</span> 三方应用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>大型互联网应用的问题：</p>
<ul>
<li>数据类型太多</li>
<li>数据源繁多，经常重构</li>
<li>数据要改造，大面积改造</li>
</ul>
<p>解决问题：</p>
<ul>
<li>加一层</li>
</ul>
<h3 id="4、NoSQL-的四大分类"><a href="#4、NoSQL-的四大分类" class="headerlink" title="4、NoSQL 的四大分类"></a>4、NoSQL 的四大分类</h3><p>KV 键值对：</p>
<ul>
<li><strong>Redis</strong></li>
<li>Redis + Tair</li>
<li>Redis + memechae</li>
</ul>
<p>文档型数据库（bson 格式 和 json 类似）：</p>
<ul>
<li><strong>MongoDB</strong>（一般必须要掌握）<ul>
<li>MongoDB 是一个基于分布式文件存储的数据库，基于 C++ 编写，主要用于处理大量的文档</li>
<li>MongoDB 是一个介于关系型数据库和非关系型数据库中间的产品。它属于 NoSQL，但是它在非关系型数据库中功能最丰富，最接近关系型数据库</li>
</ul>
</li>
<li>ConthDB</li>
</ul>
<p>列存储数据库：</p>
<ul>
<li><strong>HBase</strong></li>
<li>分布式文件系统</li>
</ul>
<p>图关系型数据库：</p>
<ul>
<li>用于存储关系，比如：朋友圈社交网络</li>
<li><strong>Neo4j</strong>，InfoGrid</li>
</ul>
<h2 id="二、Redis-入门"><a href="#二、Redis-入门" class="headerlink" title="二、Redis 入门"></a>二、Redis 入门</h2><p>Redis（Remote Dictionary Server），远程字典服务</p>
<p>也称为结构化数据库</p>
<p><strong>作用：</strong></p>
<ol>
<li>内存存储、持久化（<strong>rdb、aof</strong>）</li>
<li>效率高，可以用于高速缓存</li>
<li>发布订阅系统</li>
<li>地图信息分析</li>
<li>计时器、计数器</li>
<li>………………</li>
</ol>
<p><strong>特定：</strong></p>
<ol>
<li>多样的数据类型</li>
<li>持久化</li>
<li>集群</li>
<li>事物</li>
<li>……</li>
</ol>
<p><strong>需要用到的配置</strong></p>
<ul>
<li><p>官网：<a target="_blank" rel="noopener" href="http://www.redis.cn/documentation.html">http://www.redis.cn/documentation.html</a></p>
</li>
<li><p>端口：6379</p>
</li>
<li><p>Linux 下安装</p>
</li>
</ul>
<h3 id="1、Linux-中安装-Redis"><a href="#1、Linux-中安装-Redis" class="headerlink" title="1、Linux 中安装 Redis"></a>1、Linux 中安装 Redis</h3><p>见另一篇博文：</p>
<p><a href="https://naivekyo.github.io/2021/07/06/centos7-install-redis/">Linux 安装 Redis</a></p>
<h3 id="2、测试性能"><a href="#2、测试性能" class="headerlink" title="2、测试性能"></a>2、测试性能</h3><p>redis-benchmark 是一个压力测试工具</p>
<p>官方自带的性能测试工具</p>
<p><img src="https://naivekyo.oss-cn-hangzhou.aliyuncs.com/blog%27image/benchmark.png"></p>
<p>简单测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 测试：100 个并发连接 100000 请求</span>
<span class="token comment"># 如果 redis 设置有密码，则需要加上 -a 密码</span>
redis-benchmark -h <span class="token number">127.0</span>.0.1 -p <span class="token number">6379</span> -c <span class="token number">100</span> -n <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="3、基础知识"><a href="#3、基础知识" class="headerlink" title="3、基础知识"></a>3、基础知识</h3><p>redis 默认有 16 个数据库，默认使用的是第 0 个数据库</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># Set the number of databases. The default database is DB 0, you can select
# a different one on a per-connection basis using SELECT &lt;dbid&gt; where
# dbid is a number between 0 and 'databases'-1
databases 16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以使用 <code>select </code>进行切换数据库</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token keyword">select</span> <span class="token number">2</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> dbsize 	<span class="token comment"># 查看数据库大小</span>

<span class="token comment"># 查看当前数据库所有的 key</span>
keys *

<span class="token comment"># 清空所有数据	</span>
flushall 	<span class="token comment"># 清空所有数据库</span>
flushdb	<span class="token comment"># 清除当前数据库</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p><strong>Redis 是单线程的</strong></p>
</blockquote>
<p>Redis 非常快，是基于内存操作，所以 CPU 不是 Redis 的性能瓶颈，Redis 受机器的内存和网络带宽影响，既然可以使用单线程，就使用单线程。</p>
<p>Redis 使用 C 语言编写，官方提供的数据是 100000+ 的 QPS，不比 Memecache 差。</p>
<p><strong>Redis 为什么单线程还是这么快？</strong></p>
<ol>
<li>误区1：高性能的服务器一定是多线程的？</li>
<li>误区2：多线程（上下文切换也会消耗资源）一定比单线程效率高</li>
</ol>
<p>先去了解 CPU &gt; 内存 &gt; 硬盘 （速度）</p>
<p>核心：<strong>Redis 将所有的数据全部放在内存中，所以说使用单线程效率就是最高的</strong>，多线程上下文切换是需要消耗时间的，对于内存系统，没有上下文切换效率就是最高的。多次读写都是在一个 CPU，在内存情况就是最佳方案。</p>
<h2 id="三、五大数据类型"><a href="#三、五大数据类型" class="headerlink" title="三、五大数据类型"></a>三、五大数据类型</h2><p>Redis 是一个开源的，内存中的数据结构存储系统，它可以用作<strong>数据库</strong>、<strong>缓存</strong>和<strong>消息中间件MQ</strong>。它支持多种类型的数据结构，如 字符串（Strings），散列（hashs）、列表（lists）、集合（sets）、有序集合（sorted sets）与范围查询，bitmaps，hyperloglogs和地理空间（geospatial）索引半径查询。Redis 内置了 复制（replication），LUA 脚本（lua scripting），LRU 驱动事件（LRU eviction），事物（transactions）和不同级别的 磁盘持久化（persistence），并通过 Redis 哨兵（Sentinel）和自动分区（Cluster）提供高可用性（high availablity）（其实就是搭建集群）</p>
<h3 id="1、Redis-Key"><a href="#1、Redis-Key" class="headerlink" title="1、Redis-Key"></a>1、Redis-Key</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 判断某个 key 是否存在</span>
exists 键名

<span class="token comment"># 将当前数据库下的某个 key 移动到其他的数据库</span>
move 键名 其他数据库编号

<span class="token comment"># 给某个 key 设置过期时间</span>
expire 键名 秒数

<span class="token comment"># 查看某个 key 的剩余有效期</span>
ttl 键名

<span class="token comment"># 查看某个 key 的类型</span>
<span class="token builtin class-name">type</span> 键名

<span class="token comment"># 删除 key</span>
del 键名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><strong>Java 中可以使用 <code>Jedis</code> 连接 Redis 服务器，进行相关的操作</strong></p>
</li>
<li><p><strong>单点登录</strong> 可以给用户数据设置过期时间</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.redis.cn/commands.html">http://www.redis.cn/commands.html</a></p>
</li>
</ul>
<h3 id="2、String（字符串）"><a href="#2、String（字符串）" class="headerlink" title="2、String（字符串）"></a>2、String（字符串）</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 向字符串类型的 key 追加字符</span>
<span class="token comment"># 如果要追加的 key 不存在就相当于 set key</span>
append 键名 追加字符

<span class="token comment"># 查看字符串类型 key 的长度</span>
strlen 键名

<span class="token comment"># value 加 1</span>
incr 键名

<span class="token comment"># value 减 1</span>
decr 键名

<span class="token comment"># 加减操作的步长</span>
incrby 键名 步长
decrby 键名 步长

<span class="token comment"># 字符串范围，默认从 0 开始计数</span>
getrange 键名 开始 结束
<span class="token comment"># 查看完整的字符串</span>
getrange 键名 <span class="token number">0</span> -1

<span class="token comment"># 替换字符串，从某个下标开始替换</span>
setrange 键名 offset value

<span class="token comment"># 如果当前键存在 setex (set with expire) 设置过期时间</span>
setex 键名 过期时间 新的值
<span class="token comment"># 如果当前键不存在 setnx (set if not exist) 就设置这个 key</span>
setnx 键名 新的值

<span class="token comment"># 批量设置key</span>
mset key1 value1 key2 value2 <span class="token punctuation">..</span>.
<span class="token comment"># 批量获取</span>
mget key1 key2 key3 <span class="token punctuation">..</span>.

<span class="token comment"># 批量设置，如果遇到不存在的值则不会生效（原子性）</span>
msetnx key1 newValue key4 value4<span class="token punctuation">..</span>. <span class="token comment"># key4 不存在，则该行不生效</span>

<span class="token comment"># 先 get 再 set</span>
<span class="token comment"># 先 get 如果不存在，则返回 nil，同时再 set，创建该 key</span>
<span class="token comment"># 先 get 如果存在，再 set，会覆盖原来的值</span>
getset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>例如网站浏览量的 views 的值是通过缓存实现的，创建 <code>set views 0</code>，每次浏览使用 <code>incr views</code> 让其自动 +1</p>
</li>
<li><p><strong>setnx</strong>：<strong>在分布式锁中会很常用，它可以保证当前值存在</strong></p>
</li>
<li><p><strong>msetnx：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 对象</span>
<span class="token builtin class-name">set</span> user:1 <span class="token punctuation">{</span>name:zhangsan,age:3<span class="token punctuation">}</span> <span class="token comment"># 设置 user:1 对象，值为 json 字符串</span>

<span class="token comment"># 另一种方式，批量设置和获取</span>
<span class="token comment"># 这里的 key 设计的很巧妙: user:{id}:{filed}</span>

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> mset user:1:name zhangsan user:1:age <span class="token number">21</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> mget user:1:name user:1:age
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"zhangsan"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"21"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>String 类型的使用场景：value 除了是字符串还可以是数字</p>
<ul>
<li>计数器</li>
<li>统计多单位数量</li>
<li>粉丝数</li>
<li>对象缓存存储</li>
</ul>
</li>
</ul>
<h3 id="3、List"><a href="#3、List" class="headerlink" title="3、List"></a>3、List</h3><p>基本的数据类型，列表</p>
<p>给 List 添加一些规则就可以实现一些特殊的操作（栈、队列）</p>
<p>在 redis 中，可以将 list 做成 栈、队列</p>
<p><strong>所有的 List 命令都是以 l 开头的</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lpush list one	<span class="token comment"># 将一个值或多个值插入列表的头部(左)</span>
rpush list four <span class="token comment"># 将一个值或多个值插入列表的尾部(右)</span>

lpush list two

lpush list three

lrange list <span class="token number">0</span> -1  <span class="token comment"># 取一定范围的列表中的值</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"three"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"two"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"one"</span>
lrange list <span class="token number">0</span> <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"three"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"two"</span>


<span class="token comment"># 移除值</span>
lpop list <span class="token comment"># 默认只移除一个</span>
lpop list <span class="token number">2</span> <span class="token comment"># 移除头部两个值</span>
rpop list <span class="token comment"># 一样的，只不过从尾部开始</span>


<span class="token comment"># 下标操作</span>
lindex list <span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token comment"># 下标从 0 开始</span>

<span class="token comment"># 长度</span>
llen 列表名

<span class="token comment"># 移除指定的值</span>
lrem list 数量 值 <span class="token comment"># 从列表头开始移除指定数量的某一个值(精确匹配)</span>

<span class="token comment"># 保留一部分元素（截断操作）</span>
ltrim list start end <span class="token comment"># 保留该下标范围内的元素</span>

<span class="token comment"># 移除列表的最后一个元素并且将它添加到一个新的列表的头部</span>
rpoplpush <span class="token builtin class-name">source</span> destination <span class="token comment"># 如果 destination 不存在则新建列表</span>

<span class="token comment"># 判断列表是否存在</span>
exists 列表名

<span class="token comment"># 更新某个列表指定索引处的值，前提该列表必须存在</span>
lset 列表名 索引 值

<span class="token comment"># 在列表中指定值的前面或后面插入新的值</span>
linsert key BEFORE<span class="token operator">|</span>AFTER pivot element <span class="token comment"># pivot 指具体的值</span>
linsert mylist before <span class="token string">"v1"</span> <span class="token string">"v4"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>小结</p>
</blockquote>
<ul>
<li>list 实际上是一个<strong>链表</strong></li>
<li>如果 key 不存在，就会创建新的链表</li>
<li>如果 key 存在，则新增内容</li>
<li>如果移除了所有值，得到空链表，也代表不存在</li>
<li>在两边插入或者改动值，效率最高，但是如果对中间元素进行操作，效率会变低</li>
</ul>
<p>消息排队、消息队列、栈</p>
<h3 id="4、Set（集合）"><a href="#4、Set（集合）" class="headerlink" title="4、Set（集合）"></a>4、Set（集合）</h3><p>set 中的值不能重复</p>
<p>Redis 中涉及到 set 的命令都是 s 开头</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 set 并添加元素</span>
sadd myset <span class="token string">"hello"</span><span class="token punctuation">..</span>.

<span class="token comment"># 获取 set 的所有元素</span>
smembers myset

<span class="token comment"># 判断某个值是不是 set 的成员</span>
sismember myset <span class="token string">"hello"</span>

<span class="token comment"># 移除 set 中的指定元素</span>
srem myset <span class="token string">"hello"</span>

<span class="token comment"># 查看 set 的长度</span>
scard myset

<span class="token comment"># redis set 封装了获取随机元素的 api</span>
srandmember myset <span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token comment"># 随机获取指定数量的元素</span>

<span class="token comment"># 随机删除指定数量的 key</span>
spop myset <span class="token punctuation">[</span>count<span class="token punctuation">]</span>

<span class="token comment"># 从一个set中将指定的值移动到另外的一个set中</span>
smove <span class="token builtin class-name">source</span> destination member
smove set1 set2 <span class="token string">"v1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>set 是无序不重复集合，可以做到抽取随机元素</p>
</li>
<li><p>共同关注（并集）</p>
<ul>
<li>差集、交集、并集</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 差集</span>
<span class="token function">sdiff</span> key <span class="token punctuation">[</span>key<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token comment"># 交集</span>
sinter key <span class="token punctuation">[</span>key<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token comment"># 并集</span>
sunion key <span class="token punctuation">[</span>key<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="5、Hash（散列）"><a href="#5、Hash（散列）" class="headerlink" title="5、Hash（散列）"></a>5、Hash（散列）</h3><p>可以理解为 key-map</p>
<p>原本的 k-v 中 value 变成了 map</p>
<p>Redis 中所有与 hash 相关的命令都是以 h 开头</p>
<p>hash 本质和 String 类型没有太大区别，还是一个简单的 key-value</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置 hash</span>
hset myhash field value

<span class="token comment"># 获取 hash</span>
hget myhash field

<span class="token comment"># 设置或者获取多个 hash</span>
hmset myhash field1 hello field2 world
hmget myhash field1 field2

<span class="token comment"># 获取一个 hash 中所有 key-value</span>
hgetall myhash

<span class="token comment"># 删除至少一个 field</span>
hdel myhash field1 <span class="token punctuation">..</span>.

<span class="token comment"># 获取一个 hash 的 key 的数量</span>
hlen myhash

<span class="token comment"># 判断 hash 中某个 key 是否存在</span>
hexists myhash field1

<span class="token comment"># 只获得所有的 field </span>
hkeys myhash
<span class="token comment"># 只获取所有的 value</span>
hvals myhash

<span class="token comment"># 让某个 field 对应的 value 自增或自减 incr decr</span>
<span class="token comment"># 指定增量</span>
hincrby myhash field3 <span class="token number">3</span>
hincrby myhash field3 -1

<span class="token comment"># 如果存在</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hsetnx myhash field4 <span class="token builtin class-name">test</span> <span class="token comment"># 如果不存在就可以使用</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hsetnx myhash field4 tes <span class="token comment"># 如果存在就不可以使用</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>hash 可以存放一些变更的数据：<code>hmset user:1 name kyo age 11</code></p>
<p>尤其是用户信息的保存或者经常变动的信息。</p>
<p><strong>hash 更适合 对象 的存储</strong></p>
<p><strong>String 更加适合字符串存储</strong></p>
<h3 id="6、Zset（有序集合）"><a href="#6、Zset（有序集合）" class="headerlink" title="6、Zset（有序集合）"></a>6、Zset（有序集合）</h3><p>在 set 的基础上增加了一个值，zset k1 score1 v1，中间加上一个标志用于声明优先级</p>
<p>zset 相关的命令都是以 z 开头</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加至少一个值</span>
zadd myset <span class="token number">1</span> one
zadd myset <span class="token number">2</span> two <span class="token number">3</span> three

<span class="token comment"># 获取值</span>
zrange myset <span class="token number">0</span> -1

<span class="token comment"># 实现排序</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> zadd salary <span class="token number">2500</span> userOne
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> zadd salary <span class="token number">1000</span> userTwo
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> zadd salary <span class="token number">500</span> userThree
<span class="token comment"># 根据 score 排序，升序排列，显示所有数据，负无穷到正无穷</span>
zrangebyscore salary -inf +inf
<span class="token comment"># min 和 max 默认是 大于等于和小于等于，如果是半闭合，可以这样</span>
zrangebyscore salary <span class="token punctuation">(</span><span class="token number">100</span> <span class="token number">500</span>
<span class="token comment"># 根据 score 排序，降序排列</span>
zrevrangebyscore salary +inf -inf withscores

<span class="token comment"># 移除指定元素</span>
zrem salary userOne

<span class="token comment"># 查看 Zset 中元素的个数</span>
zcard salary

<span class="token comment"># 查看符合指定区间的元素个数</span>
zcount salary <span class="token number">100</span> <span class="token number">700</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>多看官方文档：<a target="_blank" rel="noopener" href="https://redis.io/commands">https://redis.io/commands</a></p>
<p>案例思路：zset 排序 存储班级成绩表、工资表排序</p>
<p>普通消息：1、重要消息：2，带权重进行判断</p>
<p>排行榜应用实现，取 TopN</p>
<h2 id="四、三种特殊数据类型"><a href="#四、三种特殊数据类型" class="headerlink" title="四、三种特殊数据类型"></a>四、三种特殊数据类型</h2><h3 id="1、geospatial（地理位置）"><a href="#1、geospatial（地理位置）" class="headerlink" title="1、geospatial（地理位置）"></a>1、geospatial（地理位置）</h3><p>朋友的定位、附近的人、打车距离计算</p>
<p>Redis 的 Geo 在 Redis3.2 版本就已经推出了，这个功能可以推算地理位置的信息，两地之间的距离，周围的人</p>
<p>可以查询一些测试数据 ：<a target="_blank" rel="noopener" href="http://www.jsons.cn/lngcode/">http://www.jsons.cn/lngcode/</a></p>
<p>Redis 中所有和 geospatial 相关的命令都是以 geo 开头</p>
<blockquote>
<p>geoadd</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加地理位置</span>
<span class="token comment"># 规则：两极无法直接添加，我们一般会下载城市数据，通过 Java 程序一次性导入</span>
<span class="token comment"># 参数 key (纬度、经度、名称)</span>
<span class="token comment"># 有效经度从-180到180度</span>
<span class="token comment"># 有效纬度从 -85.05112878 到 85.05112878 度</span>

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> geoadd china:city <span class="token number">30.24</span> <span class="token number">120.16</span> hangzhou <span class="token number">34.26</span> <span class="token number">108.96</span> xian
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>

<span class="token comment"># 官网例子</span>
GEOADD Sicily <span class="token number">13.361389</span> <span class="token number">38.115556</span> <span class="token string">"Palermo"</span> <span class="token number">15.087269</span> <span class="token number">37.502669</span> <span class="token string">"Catania"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>geopos</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取指定城市的维度和经度</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> geopos Sicily Palermo Catania
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"13.36138933897018433"</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"38.11555639549629859"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"15.08726745843887329"</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"37.50266842333162032"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>geodist</p>
</blockquote>
<p>两者之间的距离</p>
<p>单位</p>
<ul>
<li>m 米</li>
<li>km 千米</li>
<li>mi 英里</li>
<li>ft 英尺</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看的是直线距离</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> geodist Sicily Palermo Catania m
<span class="token string">"166274.1516"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> geodist Sicily Palermo Catania km
<span class="token string">"166.2742"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> geodist Sicily Palermo Catania ft
<span class="token string">"545518.8700"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> geodist Sicily Palermo Catania mi
<span class="token string">"103.3182"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>georadius 以给定的经纬度为中心，找出某一半径内的元素</p>
</blockquote>
<p>附近的人（获取所有附近的人的地址：定位）通过半径来查询</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>  GEORADIUS Sicily <span class="token number">15</span> <span class="token number">37</span> <span class="token number">200</span> km WITHDIST
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"Palermo"</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"190.4424"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"Catania"</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"56.4413"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>  GEORADIUS Sicily <span class="token number">15</span> <span class="token number">37</span> <span class="token number">200</span> km
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"Palermo"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"Catania"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>georadiusbymember</p>
</blockquote>
<p>找出位于指定范围内的元素，中心点是由给定的位置元素决定的</p>
<blockquote>
<p>geohash</p>
</blockquote>
<p>返回一个或多个位置元素的 Geohash 表示</p>
<p>目前用不到</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将二维的经纬度转换为一维的字符串，如果两个字符串越接近，那么距离就越近</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<blockquote>
<p>GEO 底层实现原理：Zset，可以使用 Zset 命令操作 geo</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 geospatial 中所有数据</span>
<span class="token comment"># zset 的所有命令都适用于 geospatial</span>
zrange Sicily <span class="token number">0</span> -1 

<span class="token comment"># 移除指定元素</span>
zrem Sicily Palermo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h3 id="2、hyperloglog"><a href="#2、hyperloglog" class="headerlink" title="2、hyperloglog"></a>2、hyperloglog</h3><blockquote>
<p>什么是基数？</p>
</blockquote>
<p>A{1, 3,  5, 7, 8, 7}</p>
<p>B{1, 3, 5, 7, 8}</p>
<p>基数：集合的个数（要求没有重复）</p>
<p><strong>简介：</strong></p>
<p>Redis 2.8.9 就更新了 Hyperloglog 数据结构</p>
<p>Redsi Hyperloglog 基数统计的算法</p>
<p>网页的 UV（一个人访问一个网站，但是还是算作一个人）</p>
<p>传统的方式：set 保存用户的 Id，就可以统计 set 中的元素数量作为标准判断（可能存在误差）</p>
<p>这种方式如果保存大量用户 id ，会比较麻烦。我们的目的是为了计数，而不是保存用户 id。</p>
<p>Hyperloglog：<strong>优点</strong></p>
<ul>
<li>占用的内存是固定的</li>
<li>例如，2^64 个不同的基数，只需要 12KB 内存</li>
</ul>
<p>Redis 中所有和 hyperloglog 相关的命令都是以 pf 开头</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建第一组元素</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> pfadd mykey a b c d e f g h i j
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>

<span class="token comment"># 统计 mykey 中的基数</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> pfcount mykey
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">10</span>

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> pfadd mykey2 a a b c d
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> pfcount mykey2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span>

<span class="token comment"># 合并 mykey 和 mykey2 生成 mykey3，mykey3 中无重复元素</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> pfmerge mykey3 mykey mykey2
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> keys *
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"mykey"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"mykey3"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"mykey2"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> pfcount mykey3
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果匀速容错，一定可以使用 hyperloglog</p>
<p>如果不允许容错，可以使用 set 或者自定义一种数据类型</p>
<h3 id="3、bitmaps"><a href="#3、bitmaps" class="headerlink" title="3、bitmaps"></a>3、bitmaps</h3><blockquote>
<p>位存储</p>
</blockquote>
<p>每一位用户用 0 或 1 表示</p>
<p>统计用户信息：活跃、不活跃，登录、未登录</p>
<p>打卡，一年365天，每一天都有两个状态</p>
<p>bitmaps：位图，也是一种数据结构，操作二进制位来进行记录，0 和 1 两种状态</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>例如：使用 bitmaps 记录一星期的打卡</p>
<p>周一：1 周二：0</p>
<p>统计的时候只需要统计有多少个 1</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> setbit sign <span class="token number">0</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> setbit sign <span class="token number">1</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> setbit sign <span class="token number">2</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> setbit sign <span class="token number">3</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> setbit sign <span class="token number">4</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> setbit sign <span class="token number">5</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> setbit sign <span class="token number">6</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看某一天是否有打卡</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> getbit sign <span class="token number">3</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> getbit sign <span class="token number">6</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>统计打卡天数</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bitcount key start end
<span class="token comment"># 默认的 bitcount key 统计所有值为 1 的数量</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>





<h2 id="五、事务"><a href="#五、事务" class="headerlink" title="五、事务"></a>五、事务</h2><p>MySQL：ACID</p>
<p>要么同时成功，要么同时失败：原子性</p>
<p>Redis 事务的本质：一组命令的集合！一个事务所有命令都会被序列化，在事务执行过程中，会按照顺序执行</p>
<ul>
<li>一次性</li>
<li>顺序性</li>
<li>排他性（不允许被其他命令干扰）</li>
</ul>
<p>Redis <strong>单条命令可以保证原子性</strong>，但是 <strong>Redis 中事务不保证原子性</strong></p>
<ul>
<li>Redis 事务没有隔离级别的概念（多条事务对同一资源进行操作的时候）</li>
<li>所有命令在事务并没有直接被执行，只有发起执行命令才会执行：Exec</li>
</ul>
<p>Redis 的事务：</p>
<ul>
<li>开启事务（<strong>multi</strong>）</li>
<li>命令入队（…）</li>
<li>执行事务（<strong>exec</strong>）</li>
</ul>
<p>锁：Redis 可以实现乐观锁</p>
<h3 id="1、正常执行事务"><a href="#1、正常执行事务" class="headerlink" title="1、正常执行事务"></a>1、正常执行事务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启事务</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token comment"># 命令入队</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k1 v1
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k2 v2
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> get k2
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k3 v3
QUEUED
<span class="token comment"># 执行事务</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token number">1</span><span class="token punctuation">)</span> OK
<span class="token number">2</span><span class="token punctuation">)</span> OK
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"v2"</span>
<span class="token number">4</span><span class="token punctuation">)</span> OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="2、放弃事务"><a href="#2、放弃事务" class="headerlink" title="2、放弃事务"></a>2、放弃事务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启事务</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k1 v1
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k2 v2
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k4 v4
QUEUED
<span class="token comment"># 取消事务</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> discard
OK
<span class="token comment"># 事务队列中的命令都不会被执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="3、事务中的异常"><a href="#3、事务中的异常" class="headerlink" title="3、事务中的异常"></a>3、事务中的异常</h3><blockquote>
<p>编译型异常（代码问题，命令有错），事务中所有的命令都不会被执行</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k1 v1
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k2 v2
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k3 v3
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> getset k3
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR wrong number of arguments <span class="token keyword">for</span> <span class="token string">'getset'</span> <span class="token builtin class-name">command</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k4 v4
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k5 v5
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> EXECABORT Transaction discarded because of previous errors.
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get k5
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get k1
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<blockquote>
<p>运行时异常，如果事务队列中存在语法错误，那么执行的时候，其他命令可以正常执行</p>
</blockquote>
<p>单条命令是原子性的，但是事务中的命令队列不保证原子性和隔离性</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> k1 <span class="token string">"v1"</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> incr k1
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k2 v2
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> k3 v3
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> get k3
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR value is not an integer or out of range <span class="token comment"># 虽然第一条命令错误，但是其他命令依旧执行成功了</span>
<span class="token number">2</span><span class="token punctuation">)</span> OK
<span class="token number">3</span><span class="token punctuation">)</span> OK
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"v3"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get k2
<span class="token string">"v2"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get k3
<span class="token string">"v3"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4、监控-Watch-实现乐观锁"><a href="#4、监控-Watch-实现乐观锁" class="headerlink" title="4、监控 Watch 实现乐观锁"></a>4、<strong>监控 Watch 实现乐观锁</strong></h3><p><strong>悲观锁：</strong></p>
<ul>
<li>很悲观，认为什么时候都会出问题，无论做什么都会加锁！</li>
</ul>
<p><strong>乐观锁：</strong></p>
<ul>
<li>很乐观，认为什么时候都不会出现问题，所以不会加锁！在更新数据时才会加锁判断，在此期间是否有人修改过这个数据（相当于 MySQL 中使用 version 字段）</li>
<li>获取 version</li>
<li>更新的时候比较 version</li>
</ul>
<p>Redis 中实现乐观锁使用 Watch</p>
<blockquote>
<p>Redis 监控测试</p>
</blockquote>
<p>正常执行成功</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> money <span class="token number">100</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> out <span class="token number">0</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">watch</span> money  <span class="token comment"># 监视 money</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi  <span class="token comment"># 事务正常结束，此期间数据没有发生变动，这个时候正常执行</span>
OK
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> decrby money <span class="token number">20</span>
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> incrby out <span class="token number">20</span>
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">80</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>两个线程对同一资源进行操作：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 一条线程开启监控，同时启动事务</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">watch</span> money
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> decrby money <span class="token number">10</span>
QUEUED
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> incrby out <span class="token number">10</span>
QUEUED
<span class="token comment"># 由于监控到 money 变化，所以该事务不会成功</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>

<span class="token comment"># 在 exec 之前另一条线程改变了被监视的资源</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get money
<span class="token string">"80"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> money <span class="token number">1000</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>测试多线程修改值，使用 watch 可以当作 redis 的乐观锁操作。</strong></p>
<p>执行事务失败后如果想重新进行事务操作，就需要接触监视后重新监视新的数据</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> unwatch
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">watch</span> money
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="六、Jedis"><a href="#六、Jedis" class="headerlink" title="六、Jedis"></a>六、Jedis</h2><p>使用 Java 操作 Redis</p>
<blockquote>
<p>什么是 Jedis</p>
</blockquote>
<p>Jedis 是 Redis 官方推荐的 Java 连接开发工具，相当于 Redis 的中间件</p>
<p>导入 jedis 的依赖包，可以去找最新版本</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 使用 fastjson 存储一些数据 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.76<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="七、SpringBoot-整合"><a href="#七、SpringBoot-整合" class="headerlink" title="七、SpringBoot 整合"></a>七、SpringBoot 整合</h2><p>SpringBoot 操作数据：spring-data jpa jdbc mongodb redis</p>
<p><strong>SpringData</strong> 也是一个和 SpringBoot 齐名的项目</p>
<p><strong>说明：在 SpringBoot 2.x 后，原来使用的 Jedis 被替换为 <code>lettuce</code></strong></p>
<p>jedis: 采用的是直连，如果多个线程操作，是不安全的，如果想要避免不安全的操作，需要使用 jedis pool 连接池。更像 <strong>BIO 模式</strong></p>
<p>lettuce:  底层采用 netty，实例可以在多个线程中共享，不存在线程不安全的情况，可以减少线程数量，更像 <strong>NIO 模式</strong></p>
<h3 id="1、回顾-springboot-配置"><a href="#1、回顾-springboot-配置" class="headerlink" title="1、回顾 springboot 配置"></a>1、回顾 springboot 配置</h3><ul>
<li>springboot 所有的配置类，都有一个自动配置类</li>
<li>自动配置类都会绑定一个 properties 配置文件</li>
<li>查看的方法：<ul>
<li>第一步：找到 springboot 的配置 jar <code>org.springframework.boot:spring-boot-autoconfigure</code></li>
<li>第二步：找到 META-INFO 下面的 <code>spring.factories</code></li>
<li>第三步：搜索 Redis，找到 对应的自动配置类 <code>RedisAutoConfiguration</code></li>
<li>第四步：找到绑定的配置文件类：<code>@EnableConfigurationProperties(RedisProperties.class)</code></li>
<li>第五步：找到配置类绑定的前缀：<code>@ConfigurationProperties(prefix = "spring.redis")</code></li>
</ul>
</li>
</ul>
<h3 id="2、分析-RedisAutoConfiguration"><a href="#2、分析-RedisAutoConfiguration" class="headerlink" title="2、分析 RedisAutoConfiguration"></a>2、分析 RedisAutoConfiguration</h3><p>分析 <strong>RedisAutoConfiguration</strong> 类</p>
<p>其中注册了两个 Bean：</p>
<ul>
<li><code>RedisTemplate</code></li>
<li><code>StringRedisTemplate</code></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">RedisOperations</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token comment">// 绑定配置属性类</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">RedisProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">LettuceConnectionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">JedisConnectionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisAutoConfiguration</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span>
  <span class="token comment">// 当名为 redisTemplate 的 bean 不存在时，RedisTemplate 生效</span>
  <span class="token comment">// 意思就是如果我们自己写了一个 redisTemplate，就使用我们的</span>
	<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"redisTemplate"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认的 RedisTemplate, 没有过多的设置，redis 对象都是需要序列化的 (涉及到 NIO)</span>
    <span class="token comment">// 两个泛型都是 Object，所以后面使用的时候都需要强制类型转换</span>
		<span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> template<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 多加一个 StringRedisTemplate 是为了方便</span>
  <span class="token comment">// 上面那个适用于多种数据类型</span>
  <span class="token comment">// 下面这个只适用 String 类型</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
	<span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span> <span class="token function">stringRedisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">StringRedisTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> template<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="3、自定义-RedisTemplate"><a href="#3、自定义-RedisTemplate" class="headerlink" title="3、自定义 RedisTemplate"></a>3、自定义 RedisTemplate</h3><ul>
<li><p>导入依赖</p>
</li>
<li><p>配置连接</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># redis 配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>服务器 IP<span class="token punctuation">}</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>如果有密码需要填写<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>测试</p>
</li>
</ul>
<blockquote>
<p>总结</p>
</blockquote>
<p>由于使用 RedisTemplate 执行各种命令时必须进行序列化和反序列化的操作，所以我们会发现，在 Java 程序中可以直接根据自定义的 key 拿到值，但是在服务器端 Redis 数据库中存储的却是一些无法识别的字符，两种方法解决这个问题：</p>
<ul>
<li><p>使用 <code>StringRedisTemplate</code>，但是它只能针对 String 做一些处理，非常不方便</p>
</li>
<li><p>更改 RedisTemplate 默认的序列化方式（默认使用的是）</p>
<blockquote>
<p>By default, it uses Java serialization for its objects (through {@link JdkSerializationRedisSerializer}.For String intensive operations consider the dedicated {@link StringRedisTemplate}</p>
</blockquote>
<p>也就是说默认序列化方式是 jdk 的序列化，针对 String 类型可以使用特定的 StringRedisTemplate</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// RedisTemplate 序列化要求</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> keySerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> valueSerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> hashKeySerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> hashValueSerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// 默认的序列化方式</span>
<span class="token comment">// JDK 序列化会让字符转义</span>
<span class="token comment">// 我们需要使用 json 序列化</span>
defaultSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdkSerializationRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  

<span class="token comment">// 解决思路</span>
<span class="token comment">// 自己定义一个 RedisTemplate</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>自定义 <code>RedisTemplate</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>naivekyo<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonAutoDetect</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>jsontype<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author naivekyo
 * @date 2021/6/27
 * 
 * Redis 配置类
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 序列化配置</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// String 的序列化</span>
        <span class="token class-name">StringRedisSerializer</span> stringRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 配置具体的序列化方式</span>
        <span class="token comment">// key 采用 String 的序列化方式</span>
        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// hash 的 key 也采用 String 的序列化方式</span>
        template<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// value 序列化方式采用 jackson</span>
        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// hash 的 value 序列化方式采用 jackson</span>
        template<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">/* TODO 缓存配置 */</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>使用自定义的 <code>RedisTemplate</code> 由于有多个 RedisTemplate 所以引入的时候可以指定 bean 名称</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"redisTemplate"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="4、Redis-工具类"><a href="#4、Redis-工具类" class="headerlink" title="4、Redis 工具类"></a>4、Redis 工具类</h3><p>使用封装好的 RedisUtils</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>naivekyo<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>istack<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span><span class="token class-name">NotNull</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author naivekyo
 * @date 2021/6/27
 * 
 * Redis 工具类
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RedisUtils</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>
    
    <span class="token comment">// ================================= common ===============================</span>

    <span class="token comment">/**
     * 指定缓存失效时间
     * @param key 键
     * @param time 时间(秒)
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据 key 获取过期时间
     * @param key 键 不能为 null
     * @return 时间(秒), 返回 0 代表永久有效
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getExpire</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">getExpire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断 key 是否存在
     * @param key 键
     * @return true 存在; false 不存在
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据 key 删除缓存
     * @param key 可以传入一个或多个 
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">arrayToList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ================================ String ====================================</span>

    <span class="token comment">/**
     * 普通缓存获取
     * @param key 键
     * @return 值
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 普通缓存放入
     * @param key 键
     * @param value 值
     * @return true 成功; false 失败
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 普通缓存放入并设置时间
     * @param key 键
     * @param value 值
     * @param time 时间(秒) time 要大于 0，如果 time 小于 0，将设置无限期
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 递增
     * @param key   键
     * @param delta 要增加几(大于0)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">incr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"递增因子必须大于0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 递减
     * @param key   键
     * @param delta 要减少几(小于0)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">decr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"递减因子必须大于0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">-</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ============================= Map =================================</span>

    <span class="token comment">/**
     * HashGet
     * @param key  键 不能为null
     * @param item 项 不能为null
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">hget</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取 hashKey 对应的所有键值
     * @param key 键
     * @return 对应的多个键值
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">hmget</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * HashSet
     * @param key 键
     * @param map 对应多个键值
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hmset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * HashSet 并设置时间
     * @param key  键
     * @param map  对应多个键值
     * @param time 时间(秒)
     * @return true成功 false失败
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hmset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 向一张 hash 表中放入数据,如果不存在将创建
     *
     * @param key   键
     * @param item  项
     * @param value 值
     * @return true 成功 false失败
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 向一张 hash 表中放入数据,如果不存在将创建, 并设置过期时间
     *
     * @param key   键
     * @param item  项
     * @param value 值
     * @param time  时间(秒) 注意:如果已存在的hash表有时间,这里将会替换原有的时间
     * @return true 成功 false失败
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hset</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除 hash 表中的值
     *
     * @param key  键 不能为null
     * @param item 项 可以使多个 不能为null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hdel</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断 hash 表中是否有该项的值
     *
     * @param key  键 不能为null
     * @param item 项 不能为null
     * @return true 存在 false不存在
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hHasKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * hash 递增 如果不存在,就会创建一个 并把新增后的值返回
     *
     * @param key  键
     * @param item 项
     * @param by   要增加几(大于0)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">hincr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token keyword">double</span> by<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> by<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * hash 递减
     *
     * @param key  键
     * @param item 项
     * @param by   要减少记(小于0)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">hdecr</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> item<span class="token punctuation">,</span> <span class="token keyword">double</span> by<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token operator">-</span>by<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ==================================== Set =========================================</span>

    <span class="token comment">/**
     * 根据 key 获取 Set 中的所有值
     * @param key 键
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">sGet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据 value 从一个 set 中查询,是否存在
     *
     * @param key   键
     * @param value 值
     * @return true 存在 false不存在
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sHasKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将数据放入 set 缓存
     *
     * @param key    键
     * @param values 值 可以是多个
     * @return 成功个数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将 set 数据放入缓存, 并设置过期时间
     *
     * @param key    键
     * @param time   时间(秒)
     * @param values 值 可以是多个
     * @return 成功个数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sSetAndTime</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取 set 缓存的长度
     *
     * @param key 键
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sGetSetSize</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 移除值为 value 的缓存
     *
     * @param key    键
     * @param values 值 可以是多个
     * @return 移除的个数
     */</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">setRemove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ============================== List ==========================================</span>

    <span class="token comment">/**
     * 获取 list 缓存的内容
     *
     * @param key   键
     * @param start 开始
     * @param end   结束 0 到 -1 代表所有值
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">lGet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">long</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取 list 缓存的长度
     *
     * @param key 键
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">lGetListSize</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通过索引 获取 list 中的值
     *
     * @param key   键
     * @param index 索引 index&gt;=0时， 0 表头，1 第二个元素，依次类推；index&lt;0时，-1，表尾，-2倒数第二个元素，依次类推
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">lGetIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将 list 放入缓存
     *
     * @param key   键
     * @param value 值
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPush</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将 list 放入缓存，并设置过期时间
     * @param key   键
     * @param value 值
     * @param time  时间(秒)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPush</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将 list 放入缓存
     *
     * @param key   键
     * @param value 值
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将 list 放入缓存, 并设置过期时间
     *
     * @param key   键
     * @param value 值
     * @param time  时间(秒)
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据索引修改 list 中的某条数据
     *
     * @param key   键
     * @param index 索引
     * @param value 值
     * @return
     */</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lUpdateIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> index<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 移除 N 个值为 value 的缓存
     *
     * @param key   键
     * @param count 移除多少个
     * @param value 值
     * @return 移除的个数
     */</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">lRemove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> remove <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> count<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> remove<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h3><p><strong>通过 Java 操作 Redis 十分简单，更重要的是要去理解 Redis 的思想以及每一种数据结构的用处场景。</strong></p>
<p>关于对象的保存：</p>
<p>企业开发中所有的 pojo 类都必须实现 <code>Serializable</code> 接口，定义 <code>serialVersionUID</code></p>
<blockquote>
<p>objectMapper.enableDefaultTyping()  <strong>过时问题</strong></p>
</blockquote>
<p>查看 <code>ObjectMapper</code> 源码，推荐使用 <code>activateDefaultTyping()</code></p>
<p>博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zzhongcy/article/details/105813105">https://blog.csdn.net/zzhongcy/article/details/105813105</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Base settings contain defaults used for all {@link ObjectMapper}
 * instances.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">BaseSettings</span> DEFAULT_BASE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseSettings</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// cannot share global ClassIntrospector any more (2.5+)</span>
        DEFAULT_ANNOTATION_INTROSPECTOR<span class="token punctuation">,</span>
         <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">TypeFactory</span><span class="token punctuation">.</span><span class="token function">defaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">StdDateFormat</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// to indicate "use Jackson default TimeZone" (UTC since Jackson 2.7)</span>
        <span class="token class-name">Base64Variants</span><span class="token punctuation">.</span><span class="token function">getDefaultVariant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// Only for 2.x; 3.x will use more restrictive default</span>
        <span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span>
        <span class="token comment">// Since 2.12:</span>
        <span class="token keyword">new</span> <span class="token class-name">DefaultAccessorNamingStrategy<span class="token punctuation">.</span>Provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="八、Redis-conf-详解"><a href="#八、Redis-conf-详解" class="headerlink" title="八、Redis.conf 详解"></a>八、Redis.conf 详解</h2><p>服务器端启动 Redis 服务需要指定它的配置文件</p>
<p>可以利用更改一些配置细节来优化速度</p>
<h3 id="1、单位"><a href="#1、单位" class="headerlink" title="1、单位"></a>1、单位</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Redis configuration file example.</span>
<span class="token comment">#</span>
<span class="token comment"># Note that in order to read the configuration file, Redis must be</span>
<span class="token comment"># started with the file path as first argument:</span>
<span class="token comment">#</span>
<span class="token comment"># ./redis-server /path/to/redis.conf</span>

<span class="token comment"># Note on units: when memory size is needed, it is possible to specify</span>
<span class="token comment"># it in the usual form of 1k 5GB 4M and so forth:</span>
<span class="token comment">#</span>
<span class="token comment"># 1k =&gt; 1000 bytes</span>
<span class="token comment"># 1kb =&gt; 1024 bytes</span>
<span class="token comment"># 1m =&gt; 1000000 bytes</span>
<span class="token comment"># 1mb =&gt; 1024*1024 bytes</span>
<span class="token comment"># 1g =&gt; 1000000000 bytes</span>
<span class="token comment"># 1gb =&gt; 1024*1024*1024 bytes</span>
<span class="token comment">#</span>
<span class="token comment"># units are case insensitive so 1GB 1Gb 1gB are all the same.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>1、配置文件 unit 单位对大小写不敏感</p>
<h3 id="2、包含"><a href="#2、包含" class="headerlink" title="2、包含"></a>2、包含</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">################################## INCLUDES ###################################</span>

<span class="token comment"># Include one or more other config files here.  This is useful if you</span>
<span class="token comment"># have a standard template that goes to all Redis servers but also need</span>
<span class="token comment"># to customize a few per-server settings.  Include files can include</span>
<span class="token comment"># other files, so use this wisely.</span>
<span class="token comment">#</span>
<span class="token comment"># Note that option "include" won't be rewritten by command "CONFIG REWRITE"</span>
<span class="token comment"># from admin or Redis Sentinel. Since Redis always uses the last processed</span>
<span class="token comment"># line as value of a configuration directive, you'd better put includes</span>
<span class="token comment"># at the beginning of this file to avoid overwriting config change at runtime.</span>
<span class="token comment">#</span>
<span class="token comment"># If instead you are interested in using includes to override configuration</span>
<span class="token comment"># options, it is better to use include as the last line.</span>
<span class="token comment">#</span>
<span class="token comment"># include /path/to/local.conf</span>
<span class="token comment"># include /path/to/other.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Redis 的配置文件可以不止一个，但是有一个主要的配置文件，它可以引入其他配置文件。</p>
<h3 id="3、模块"><a href="#3、模块" class="headerlink" title="3、模块"></a>3、模块</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">################################## MODULES #####################################</span>

<span class="token comment"># Load modules at startup. If the server is not able to load modules</span>
<span class="token comment"># it will abort. It is possible to use multiple loadmodule directives.</span>
<span class="token comment">#</span>
<span class="token comment"># loadmodule /path/to/my_module.so</span>
<span class="token comment"># loadmodule /path/to/other_module.so</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4、网络"><a href="#4、网络" class="headerlink" title="4、网络"></a>4、网络</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Redis 绑定监听端口, 不要开放允许所有 IP 连接 Redis 服务器</span>
<span class="token comment"># 默认监听本地 IP, 只允许本机连接</span>
<span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1 -::1

<span class="token comment"># Redis 的保护模式</span>
<span class="token comment"># 如果开启了保护模式, 但是没有指定监听一组 IP, 且开启密码, 那么 Redis 只允许本机客户端连接</span>
<span class="token comment"># 保护模式默认是开启的, 想关闭它时, 必须确认要从其他客户端连接 Redis 服务器且使用 bind 命令监听指定 IP 的访问请求。</span>
protected-mode no

<span class="token comment"># Redis 默认监听端口 6379, 如果指定监听端口 0, 那么 Redis 将不会监听 TCP 连接</span>
port <span class="token number">6379</span>

<span class="token comment"># 剩下的就是一些超市配置和 ssl 认证, 暂时只做了解</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="5、通用"><a href="#5、通用" class="headerlink" title="5、通用"></a>5、通用</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 是否以守护进程方式开启 Redis 服务</span>
<span class="token comment"># yes 则会在 /var/run/redis.pid 创建一个 pid 文件, Redis 会在后台运行(推荐使用)</span>
<span class="token comment"># 默认是 no</span>
daemonize <span class="token function">yes</span>

<span class="token comment"># 如果 Redis 进程被 upstart 或者 systemd 命令监控, 则 daemonize 配置无效</span>
<span class="token comment"># 默认不开启</span>
supervised no

<span class="token comment"># pid 文件位置</span>
pidfile /var/run/redis_6379.pid

<span class="token comment"># 日志级别</span>
<span class="token comment"># Specify the server verbosity level.</span>
<span class="token comment"># This can be one of:</span>
<span class="token comment"># debug (a lot of information, useful for development/testing)</span>
<span class="token comment"># verbose (many rarely useful info, but not a mess like the debug level)</span>
<span class="token comment"># notice (moderately verbose, what you want in production probably)</span>
<span class="token comment"># warning (only very important / critical messages are logged)</span>
loglevel notice


<span class="token comment"># 日志文件</span>
<span class="token comment"># Specify the log file name. Also the empty string can be used to force</span>
<span class="token comment"># Redis to log on the standard output. Note that if you use standard</span>
<span class="token comment"># output for logging but daemonize, logs will be sent to /dev/null</span>
logfile <span class="token string">""</span> <span class="token comment"># 日志的文件位置名，为空代表标准输出</span>

<span class="token comment"># 默认数据库数量</span>
<span class="token comment"># Set the number of databases. The default database is DB 0, you can select</span>
<span class="token comment"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span>
<span class="token comment"># dbid is a number between 0 and 'databases'-1</span>
databases <span class="token number">16</span>

<span class="token comment"># 是否显示 Redis 的启动 logo</span>
always-show-logo no

<span class="token comment"># 修改进程的标题, no 表示修改</span>
<span class="token comment"># By default, Redis modifies the process title (as seen in 'top' and 'ps') to</span>
<span class="token comment"># provide some runtime information. It is possible to disable this and leave</span>
<span class="token comment"># the process name as executed by setting the following to no.</span>
set-proc-title <span class="token function">yes</span>

<span class="token comment"># 如果要修改进程标题</span>
<span class="token comment"># When changing the process title, Redis uses the following template to construct</span>
<span class="token comment"># the modified title.</span>
<span class="token comment">#</span>
<span class="token comment"># Template variables are specified in curly brackets. The following variables are</span>
<span class="token comment"># supported:</span>
<span class="token comment">#</span>
<span class="token comment"># {title}           Name of process as executed if parent, or type of child process.</span>
<span class="token comment"># {listen-addr}     Bind address or '*' followed by TCP or TLS port listening on, or</span>
<span class="token comment">#                   Unix socket if only that's available.</span>
<span class="token comment"># {server-mode}     Special mode, i.e. "[sentinel]" or "[cluster]".</span>
<span class="token comment"># {port}            TCP port listening on, or 0.</span>
<span class="token comment"># {tls-port}        TLS port listening on, or 0.</span>
<span class="token comment"># {unixsocket}      Unix domain socket listening on, or "".</span>
<span class="token comment"># {config-file}     Name of configuration file used.</span>
<span class="token comment">#</span>
proc-title-template <span class="token string">"{title} {listen-addr} {server-mode}"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="6、快照"><a href="#6、快照" class="headerlink" title="6、快照"></a>6、快照</h3><p><strong>涉及到持久化</strong></p>
<p>在规定的时间内，执行了多少操作，就会持久化到一个文件 <code>.rbd、.aof</code></p>
<p>Redis 是内存数据库，如果没有持久化，存储的数据就会断电即失</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># You can set these explicitly by uncommenting the three following lines.</span>
<span class="token comment">#</span>
<span class="token comment"># save 3600 1 # 如果一小时内，有一个 key 被修改，就进行持久化操作</span>
<span class="token comment"># save 300 100 # 300 秒内，100 个 key 被修改，就进行持久化操作</span>
<span class="token comment"># save 60 10000 # 60 秒内，。。。。。</span>
<span class="token comment"># 之后会设置自定义持久化机制</span>

<span class="token comment"># 如果持久化出现错误后，是否继续执行持久化操作，默认继续</span>
stop-writes-on-bgsave-error <span class="token function">yes</span>

<span class="token comment"># 是否压缩 rdb 文件，默认开启，需要消耗 CPU 资源</span>
rdbcompression <span class="token function">yes</span>

<span class="token comment"># 保存 rdb 文件时是否校验 rbd 文件，如果出错可以通过校验修复</span>
rdbchecksum <span class="token function">yes</span>

<span class="token comment"># rdb 文件生成目录，默认当前目录</span>
<span class="token function">dir</span> ./<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="7、复制"><a href="#7、复制" class="headerlink" title="7、复制"></a>7、复制</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">涉及到主从复制<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<h3 id="8、安全"><a href="#8、安全" class="headerlink" title="8、安全"></a>8、安全</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取密码</span>
config get requirepass
<span class="token comment"># 设置密码：两种方式，配置文件和运行时配置</span>
config get requirepass <span class="token string">"password"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>还有很多自己看</p>
<h3 id="9、客户端"><a href="#9、客户端" class="headerlink" title="9、客户端"></a>9、客户端</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置能连接上 Redis 的最大客户端的数量</span>
maxclients <span class="token number">10000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="10、内存管理"><a href="#10、内存管理" class="headerlink" title="10、内存管理"></a>10、内存管理</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># redis 配置最大的内存容量</span>
maxmemory <span class="token operator">&lt;</span>bytes<span class="token operator">&gt;</span>

<span class="token comment"># 内存达到上限后的处理策略</span>
maxmemory-policy noeviction

<span class="token comment"># MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</span>
<span class="token comment"># is reached. You can select one from the following behaviors:</span>
<span class="token comment">#</span>
<span class="token comment"># volatile-lru -&gt; 只对设置了过期时间的 key 进行 LRU (默认值)</span>
<span class="token comment"># allkeys-lru -&gt; Evict any key using approximated LRU.</span>
<span class="token comment"># volatile-lfu -&gt; Evict using approximated LFU, only ke	ys with an expire set.</span>
<span class="token comment"># allkeys-lfu -&gt; Evict any key using approximated LFU.</span>
<span class="token comment"># volatile-random -&gt; Remove a random key having an expire set.</span>
<span class="token comment"># allkeys-random -&gt; Remove a random key, any key.</span>
<span class="token comment"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span>
<span class="token comment"># noeviction -&gt; Don't evict anything, just return an error on write operations.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="11、APPEND-ONLY-MODE（aof-配置）"><a href="#11、APPEND-ONLY-MODE（aof-配置）" class="headerlink" title="11、APPEND ONLY MODE（aof 配置）"></a>11、APPEND ONLY MODE（aof 配置）</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 默认不开启，因为默认使用 rdb 方式持久化，在大部分情况下，rdb 完全够用</span>
appendonly no

<span class="token comment"># 持久化文件名</span>
appendfilename <span class="token string">"appendonly.aof"</span>

<span class="token comment"># 同步机制</span>
<span class="token comment"># appendfsync always	每次修改都会 sync，速度慢</span>
appendfsync everysec <span class="token comment"># 每秒执行一次 sync，可能会丢失这一秒的数据</span>
<span class="token comment"># appendfsync no	不执行 sync，这个时候操作系统自己同步数据，速度较快</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>具体配置看 持久化</p>
<h2 id="九、Redis-持久化"><a href="#九、Redis-持久化" class="headerlink" title="九、Redis 持久化"></a>九、Redis 持久化</h2><p>aof rdb 两种持久化方式</p>
<p>Redis 是缓存数据库，如果不能及时将内存中的数据保存到磁盘上面，一旦服务器进程退出，Redis 数据库中的所有状态都会消失，所以 Redis 提供了持久化功能</p>
<h3 id="1、RDB"><a href="#1、RDB" class="headerlink" title="1、RDB"></a>1、RDB</h3><p>Redis DataBase</p>
<p>指定时间间隔内将内存中的<strong>数据集快照</strong>写入磁盘，即 Snapshot 快照，它恢复时直接将快照文件读入到内存中。</p>
<p>Redis 会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，等待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何 IO 操作的，这就确保的极高的性能。如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那么 RDB 方式要比 AOF 方式更加高效。RDB 的缺点是最后一次持久化后的数据可能丢失（情况：最后一次持久化的时候，服务器宕机了）。</p>
<p>一般情况下默认就是 RDB。</p>
<p>rdb 保存的文件：<code>dump.rdb</code>，该文件名是在配置文件中配置的</p>
<p>配置文件，设置 <code>save 60 5</code></p>
<p>测试：删除 dump.rdb，清空数据，进入命令行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先 save 生成 dump.rdb</span>
save
<span class="token comment"># 一分钟内设置 5 个 key，触发持久化机制</span>
<span class="token comment"># 关闭 redis 服务</span>
<span class="token function">shutdown</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>触发机制</p>
</blockquote>
<p>1、客户端向 Redis 服务器发送 save 或者 bgsave 命令就会让服务器生成 rdb 文件</p>
<ul>
<li><p>save 命令是一个同步操作</p>
<ul>
<li>当客户端向服务器发送 save 命令请求进行持久化时，服务器会阻塞 save 命令之后的其他客户端的请求，直到数据同步完成。如果数据量太大，同步数据会执行很久，而这期间 Redis 服务器也无法接收其他请求，所以，最好不要在生产环境使用 save 命令。</li>
</ul>
</li>
<li><p>bgsave 是一个异步操作</p>
<ul>
<li>当客户端发服务发出 bgsave 命令时，Redis 服务器主进程会 forks 一个子进程来数据同步问题，在将数据保存到 rdb 文件之后，子进程会退出。</li>
<li>所以，与 save 命令相比，Redis 服务器在处理 bgsave 采用子线程进行 IO 写入，而主进程仍然可以接收其他请求，但 forks 子进程是同步的，所以 forks 子进程时，一样不能接收其他请求，这意味着，如果forks一个子进程花费的时间太久(一般是很快的)，bgsave 命令仍然有阻塞其他客户的请求的情况发生。</li>
</ul>
</li>
</ul>
<p>2、Redis 配置文件中定义了触发机制</p>
<ul>
<li>这种通过服务器配置文件触发RDB的方式，与 bgsave 命令类似，达到触发条件时，会 forks 一个子进程进行数据同步，不过最好不要通过这方式来触发RDB持久化，因为设置触发的时间太短，则容易频繁写入rdb文件，影响服务器性能，时间设置太长则会造成数据丢失。</li>
</ul>
<p>3、执行了 flushall 命令，也会触发 rdb 规则</p>
<p>4、退出 redis，也会产生 rdb 文件</p>
<p>触发了以上机制后，Redis 先生成临时 rdb 文件，并写入数据，完成数据写入后，就会用临时文件替代正式的 rdb 文件，最后删除原来的 rdb 文件。</p>
<blockquote>
<p>如何恢复 rdb 文件</p>
</blockquote>
<p>1、只需要将 rdb 文件放到 redis 启动目录下，redis 启动时会自动检查 dump.rdb ，然后恢复其中的数据</p>
<p>2、查看 rdb 文件存放的位置</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config get <span class="token function">dir</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"dir"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"/opt/redis-6.2.4/bin"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>优缺点</p>
</blockquote>
<p>优点：</p>
<ol>
<li>适合大规模的数据恢复</li>
<li>与AOF方式相比，通过rdb文件恢复数据比较快。</li>
<li>rdb文件非常紧凑，适合于数据备份。</li>
<li>通过RDB进行数据备份，由于使用子进程生成，所以对Redis服务器性能影响较小。</li>
<li>对数据的完整性要求不高</li>
</ol>
<p>缺点：</p>
<ol>
<li>不能完全保证数据完整性：如果服务器宕机的话，采用RDB的方式会造成某个时段内数据的丢失，比如我们设置10分钟同步一次或5分钟达到1000次写入就同步一次，那么如果还没达到触发条件服务器就死机了，那么这个时间段的数据会丢失。</li>
<li>使用 save 命令会造成服务器阻塞，直接数据同步完成才能接收后续请求。</li>
<li>使用 bgsave 命令在 forks 子进程时，如果数据量太大，forks 的过程也会发生阻塞，另外，forks 子进程会耗费内存。</li>
</ol>
<h3 id="2、AOF"><a href="#2、AOF" class="headerlink" title="2、AOF"></a>2、AOF</h3><p>Append Only File</p>
<p>与 RDB 存储某个时刻的快照不同，AOF 持久化方式会记录客户端对<strong>服务器的每一次写操作命令</strong>，并将这些写操作以 Redis 协议追加保存到以后缀为 aof 文件末尾，在 Redis 服务器重启时，会加载并运行 aof 文件的命令，以达到恢复数据的目的。</p>
<ul>
<li>以日志形式记录每一个写操作，将 Redis 执行过的所有指令记录下来（读操作不记录）</li>
<li>只许追加文件但不可以改写文件，redis 启动之初会读取该文件重构数据</li>
</ul>
<p>Aof 保存的文件是：<code>appendonly.aof</code>  文件</p>
<p>aof 功能默认不开启，需要改配置文件，而且开启后默认每一秒中都同步一次</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 手动开启</span>
appendonly <span class="token function">yes</span>
<span class="token comment"># 默认命名</span>
appendfilename <span class="token string">"appendonly.aof"</span>

<span class="token comment"># 执行策略</span>
<span class="token comment"># appendfsync always</span>
appendfsync everysec
<span class="token comment"># appendfsync no</span>

<span class="token comment"># 默认不重写aof文件</span>
no-appendfsync-on-rewrite no

<span class="token comment"># 保存目录</span>
<span class="token function">dir</span> ~/redis/

<span class="token comment"># 其余配置暂时默认即可 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>always</li>
</ol>
<p>客户端的每一个写操作都保存到aof文件当，这种策略很安全，但是每个写请注都有IO操作，所以也很慢。</p>
<ol start="2">
<li>everysec</li>
</ol>
<p>appendfsync的默认写入策略，每秒写入一次aof文件，因此，最多可能会丢失1s的数据。</p>
<ol start="3">
<li>no</li>
</ol>
<p>Redis服务器不负责写入aof，而是交由操作系统来处理什么时候写入aof文件。更快，但也是最不安全的选择，不推荐使用。</p>
<p>两种重写方式：</p>
<p>通过在redis.conf配置文件中的选项no-appendfsync-on-rewrite可以设置是否开启重写，这种方式会在每次fsync时都重写，影响服务器性以，因此默认值为no，不推荐使用。</p>
<p>客户端向服务器发送bgrewriteaof命令，也可以让服务器进行AOF重写。</p>
<p>AOF重写方式也是异步操作，即如果要写入aof文件，则Redis主进程会forks一个子进程来处理</p>
<p>重写aof文件的好处</p>
<ul>
<li>压缩 aof 文件，减少磁盘占用量。</li>
<li>将 aof 的命令压缩为最小命令集，加快了数据恢复的速度。</li>
</ul>
<p>重启 redis 自动生成 appendonly.aof</p>
<p>会发现在启动目录下存在这两个文件：</p>
<ul>
<li>appendonly.aof</li>
<li>redis-check-aof</li>
</ul>
<p>当 aof 文件出错时，可以利用后者去校验恢复数据</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 如果 appendonly.aof 出错，那么就无法启动 Redis</span>
<span class="token comment"># 利用 redis-check-aof 修复 appendonly.aof</span>
redis-check-aof --fix appendonly.aof<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>优缺点</p>
</blockquote>
<p>优点：</p>
<ol>
<li>每一次修改都同步，很好的保证了数据的完整性</li>
<li>每秒同步一次，可能会丢失一秒的数据</li>
<li>从不同步时，效率最高</li>
<li>AOF 只是追加日志文件，因此对服务器性能影响较小，速度比RDB要快，消耗的内存较少。</li>
</ol>
<p>缺点：</p>
<ol>
<li>相对于数据文件的大小，aof 远远大于 rdb，修复的速度比 rdb 慢</li>
<li>aof 运行效率比 rdb 慢，所以 redis 默认配置是 rdb</li>
</ol>
<p>如果 aof 文件大于 64MB，就会 forks 一个新的进程，将文件进行重写</p>
<h3 id="3、总结"><a href="#3、总结" class="headerlink" title="3、总结"></a>3、总结</h3><p>在主从复制中，rdb 就是备用的，放在从机上面，aof 几乎不使用</p>
<table>
<thead>
<tr>
<th align="center">方式</th>
<th align="center">RDB</th>
<th align="center">AOF</th>
</tr>
</thead>
<tbody><tr>
<td align="center">启动优先级</td>
<td align="center">低</td>
<td align="center">高</td>
</tr>
<tr>
<td align="center">体积</td>
<td align="center">小</td>
<td align="center">大</td>
</tr>
<tr>
<td align="center">恢复速度</td>
<td align="center">快</td>
<td align="center">慢</td>
</tr>
<tr>
<td align="center">数据安全性</td>
<td align="center">会丢数据</td>
<td align="center">由策略决定</td>
</tr>
<tr>
<td align="center">轻重</td>
<td align="center">重</td>
<td align="center">轻</td>
</tr>
</tbody></table>
<p>当RDB与AOF两种方式都开启时，Redis会优先使用AOF日志来恢复数据，因为AOF保存的文件比RDB文件更完整。</p>
<blockquote>
<p>扩展</p>
</blockquote>
<ol>
<li>RDB 持久化方式是在指定时间间隔内对数据进行快照存储</li>
<li>AOF 持久化记录每次对数据库写的操作，当服务器重启的时候来重新执行这些命令恢复原始数据，AOF 命令以 Redis 协议追加保存每次写的操作到文件末尾，Redis 还能对 AOF 文件进行后台重写，使得 AOF 文件的体积不至于过大</li>
<li><strong>只做缓存，可以不使用任何持久化</strong></li>
<li>同时开启两种持久化：<ul>
<li>这种情况下，Redis 重启优先载入 AOF 文件恢复数据，因为通常情况下 AOF 文件保存的数据要比 RDB 更加完整</li>
<li>RDB 保存数据不实时，同时使用两者时服务器重启也只会找 AOF 文件，那么要不要使用 AOF 呢？建议不要，因为 RDB 更适合用于备份数据库（AOF 在不断变化不好备份），快速重启，而且不会有 AOF 潜在的 bug</li>
</ul>
</li>
<li>性能建议<ul>
<li>RDB 文件只做备份，建议只在 Slave 上持久化 RDB 文件，而且只要 15 分钟备份一次就好了，只保留 <code>save 900 1</code> 这条规则</li>
<li>如果 Enable AOF，好处在于最恶劣情况下也只会丢失不超过 2 秒的数据，启动脚本只需要 load 自己的 AOF 文件就可以了，代价：一是带来了持续的 IO，二是 AOF rewrite 的最后将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少 AOF rewrite 的频率，AOF 重写的基础大小默认值 64M 太小了，可以设到 5G 以上，默认超过原大小 100% 大小重写可以改到适当的数值</li>
<li>如果不 Enable AOF，仅靠 Master-Slave Replication 实现高可用性也可以，能省掉一大笔 IO，也减少了 rewrite 时带来的系统波动。代价是如果 Master/Slave 同时宕机（最恶劣情况：断电），会丢失十几分钟的数据，启动脚本也需要比较两个 Maseter/Slave 中的 RDB 文件，载入较新的那个，微博就是这种架构</li>
</ul>
</li>
</ol>
<h2 id="十、Redis-发布订阅"><a href="#十、Redis-发布订阅" class="headerlink" title="十、Redis 发布订阅"></a>十、Redis 发布订阅</h2><p>Redsi 发布订阅（pub/sub）是一种<strong>消息通信模式</strong>：发送者（pub）发送消息，订阅者（sub）接收消息。</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<h3 id="1、简单模型"><a href="#1、简单模型" class="headerlink" title="1、简单模型"></a>1、简单模型</h3><p><img src="https://naivekyo.oss-cn-hangzhou.aliyuncs.com/blog%27image/redis-pub-sub.png"></p>
<p>重点：</p>
<ul>
<li>消息发送者</li>
<li>频道</li>
<li>消息订阅者</li>
</ul>
<h3 id="2、相关命令"><a href="#2、相关命令" class="headerlink" title="2、相关命令"></a>2、相关命令</h3><blockquote>
<p>命令</p>
</blockquote>
<p>这些命令被广泛用于构建即时通信应用，比如网络聊天室（chatroom）和实时广播、实时提醒</p>
<ul>
<li>psubscribe pattern [pattern…]   <ul>
<li>订阅一个或多个符合给定模式的频道</li>
</ul>
</li>
<li>pubsub subcommand [argument [argument …]]<ul>
<li>查看订阅与发布系统状态</li>
</ul>
</li>
<li>publish channel message<ul>
<li>将消息发送到指定的频道</li>
</ul>
</li>
<li>punsubscribe [pattern [pattern …]]<ul>
<li>退订所有给定模式的频道</li>
</ul>
</li>
<li>subscribe channle [channel …]<ul>
<li>订阅给定的一个或多个频道的信息</li>
</ul>
</li>
<li>ubsubscribe [channel [channel …]]<ul>
<li>退订给定的频道</li>
</ul>
</li>
</ul>
<h3 id="3、测试"><a href="#3、测试" class="headerlink" title="3、测试"></a>3、测试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 订阅一个频道</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> PSUBSCRIBE naivekyichannel
Reading messages<span class="token punctuation">..</span>. <span class="token punctuation">(</span>press Ctrl-C to quit<span class="token punctuation">)</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"psubscribe"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"naivekyichannel"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>

<span class="token comment"># 消息发送者发布消息</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> PUBLISH naivekyichannel <span class="token string">"hello naivekyo"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> PUBLISH naivekyichannel <span class="token string">"hello redis"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>

<span class="token comment"># 频道将消息发布给所有订阅者</span>
Reading messages<span class="token punctuation">..</span>. <span class="token punctuation">(</span>press Ctrl-C to quit<span class="token punctuation">)</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"naivekyichannel"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"naivekyichannel"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"hello naivekyo"</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"naivekyichannel"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"naivekyichannel"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"hello redis"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4、原理"><a href="#4、原理" class="headerlink" title="4、原理"></a>4、原理</h3><p>Redis 是用 C 编写的，可以分析源码（pubsub.c），了解发布和订阅机制的底层实现，加深对 Redis 的理解</p>
<p>Redis 通过 PUBLISH、SUBSCRIBE 和 PSUBSCRIBE 等命令实现发布和订阅功能</p>
<p>通过 SUBSCRIBE 命令订阅某个频道后，redis-server 里维护了一个字典，字典的键就是一个个 channel，而字典的值则是一个个链表，链表中保存了所有订阅这个 channel 的客户端。SUBSCRIBE 命令的关键，就是将客户端添加到给定 channel 的订阅链表中。</p>
<p>通过 PUBLIC 命令向订阅者发送消息，redis-server 会使用给定的频道作为键，在它所维护的 channel 字典中查找记录了订阅这个频道的所有客户端的链表，遍历这个链表，将消息发布给所有订阅者。</p>
<p>Pub/Sub 从字面上理解就是发布（Publish）与订阅（Subscribe），在 Redis 中，你可以设定一个 key 值进行消息发布及消息订阅，当一个 key 值上进行了消息发布后，所有订阅它的客户端都会收到相应的消息。这一功能最明显的用法就是用作实时消息系统，比如普通的及时聊天，群聊等功能。</p>
<p>使用场景：</p>
<ol>
<li>实时消息系统</li>
<li>实时聊天（频道当作聊天室， 将信息回显给所有人）</li>
<li>订阅、关注系统</li>
</ol>
<p>复杂的场景：会使用 消息中间件（MQ，Kafka）</p>
<h2 id="十一、Redis-主从复制"><a href="#十一、Redis-主从复制" class="headerlink" title="十一、Redis 主从复制"></a>十一、Redis 主从复制</h2><p>服务器高可用：主从复制、哨兵模式</p>
<h3 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h3><p>主从复制，指将一台 Redis 服务器的数据，复制到其他的 Redis 服务器上。前者称为 主节点（master/leader），后者称为从节点（slave/follower）；<strong>数据的复制是单向的</strong>。Master 以写为主，Slave 以读为主。</p>
<p><strong>默认情况下，每台 Redis 服务器都是主节点</strong>；</p>
<p>且一个主节点可以有多个从节点（或没有从节点），但一个从节点只能有一个主节点。</p>
<p>主从复制的作用主要包括：</p>
<ol>
<li><strong>数据冗余</strong>：主从复制实现了数据的热备份，是持久化之外的一种数据备份方式</li>
<li><strong>故障恢复</strong>：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余</li>
<li><strong>负载均衡</strong>：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写 Redis 数据时应该连接主节点，读 Redis 数据时应该连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高 Redis 服务器的并发量。</li>
<li><strong>高可用（集群）基石</strong>：除了上述作用外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是 Redis 高可用的基础</li>
</ol>
<p>一般来说，要将 Redis 用于工程项目中，只是用一台 Redis 是万万不能的（可能会宕机，一般配三台），原因如下：</p>
<ol>
<li>从结构上，单个 Redis 服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力过大。</li>
<li>从容量上，单个 Redis 服务器内存容量有限，就算一台 Redis 服务器内存容量为 256G，也不能将所有内存用作 Redis 存储内存，一般来说，单台 Redis 最大使用内存不应该超过 20G</li>
</ol>
<p>电商网站上的商品，一般都是一次存储，无数次浏览的，说专业点就是 ”多读少写“</p>
<p>对于这样的场景，我们使用如下架构：</p>
<p><img src="https://naivekyo.oss-cn-hangzhou.aliyuncs.com/blog%27image/write%26read.png"></p>
<p>主从复制、读写分离 解决大量读操作的场景，减缓服务器压力，架构中经常使用。一般：<strong>一主二从</strong>（后续哨兵模式会选举，所以最低需要三台）</p>
<h3 id="2、环境配置"><a href="#2、环境配置" class="headerlink" title="2、环境配置"></a>2、环境配置</h3><p>只配置从库，不用配置主库！（Redis 默认启动就是主库）</p>
<p>因为现在只有一台服务器，所以要配置的是单机多集群</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看当前库的信息</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> info replication
<span class="token comment"># Replication</span>
role:master               <span class="token comment"># 角色为主机</span>
connected_slaves:0				<span class="token comment"># 没有附属从机</span>
master_failover_state:no-failover
master_replid:e53a0801b50a28ab552c9e8575b8ead398c0a650
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>准备工作：</p>
<ul>
<li><p>一台服务器开四个连接 session</p>
</li>
<li><p>一主二从 + 一个测试</p>
</li>
<li><p>配置文件需要准备四个</p>
</li>
<li><p>先关闭 Redis 服务</p>
</li>
<li><p>修改配置文件（因为在一台服务器上开多个 Redis 进程，所以需要修改诸多配置）</p>
<ul>
<li>端口</li>
<li>pid 文件</li>
<li>生成日志的文件名 </li>
<li>dump 的文件名</li>
</ul>
</li>
</ul>
<h3 id="3、启动服务"><a href="#3、启动服务" class="headerlink" title="3、启动服务"></a>3、启动服务</h3><p>分别开启 一主二从 及测试 Redis 服务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@naivekyo bin<span class="token punctuation">]</span><span class="token comment"># ps aux | grep redis</span>
root     <span class="token number">31183</span>  <span class="token number">0.1</span>  <span class="token number">0.5</span> <span class="token number">162508</span>  <span class="token number">9956</span> ?        Rsl  <span class="token number">14</span>:29   <span class="token number">0</span>:00 redis-server *:6379
root     <span class="token number">31238</span>  <span class="token number">0.0</span>  <span class="token number">0.5</span> <span class="token number">162504</span>  <span class="token number">9884</span> ?        Rsl  <span class="token number">14</span>:29   <span class="token number">0</span>:00 redis-server *:6380
root     <span class="token number">31280</span>  <span class="token number">0.0</span>  <span class="token number">0.5</span> <span class="token number">162504</span>  <span class="token number">9884</span> ?        Rsl  <span class="token number">14</span>:30   <span class="token number">0</span>:00 redis-server *:6381
root     <span class="token number">31314</span>  <span class="token number">0.0</span>  <span class="token number">0.5</span> <span class="token number">162504</span>  <span class="token number">9872</span> ?        Ssl  <span class="token number">14</span>:30   <span class="token number">0</span>:00 redis-server *:6382
root     <span class="token number">31326</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span> <span class="token number">112812</span>   <span class="token number">964</span> pts/3    R+   <span class="token number">14</span>:30   <span class="token number">0</span>:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4、一主二从"><a href="#4、一主二从" class="headerlink" title="4、一主二从"></a>4、一主二从</h3><p><strong>默认情况下，每一台 Redis 服务器都是主节点</strong>；</p>
<p>一般情况下，只需要配置从机就可以了。</p>
<ul>
<li><p>主要方法是为从机指定要给 主机</p>
</li>
<li><p>例如我们现在测试用的 一主（6379）二从（6380、6381）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 主机不用管</span>

<span class="token comment"># 从机使用</span>
slaveof <span class="token function">host</span> port <span class="token comment"># 指定主机为 host.port 的 Redis 进程</span>

<span class="token comment"># 主机检测状态</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> info replication
<span class="token comment"># Replication</span>
role:master
connected_slaves:2
slave0:ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1,port<span class="token operator">=</span><span class="token number">6380</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">84</span>,lag<span class="token operator">=</span><span class="token number">0</span>
slave1:ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1,port<span class="token operator">=</span><span class="token number">6381</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">84</span>,lag<span class="token operator">=</span><span class="token number">0</span>
master_failover_state:no-failover
master_replid:76474c9a04098ec797bb5fe681943e15f0923f5d
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:84
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:84<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>如果出现 master 机 使用 info replication 显示连接状态为 down，可能是因为设置了 <strong>requirepassword</strong> 但是没有设置 <strong>masterauth</strong>，为了方便，建议两个密码设置一样</p>
</li>
</ul>
<p>真实的主从配置应该在配置文件中配置，这样才是永久的，如果使用命令配置就是暂时的。</p>
<h3 id="5、配置文件"><a href="#5、配置文件" class="headerlink" title="5、配置文件"></a>5、配置文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置主机 ip</span>
replicaof <span class="token operator">&lt;</span>masterip<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>masterport<span class="token operator">&gt;</span>
<span class="token comment"># 。。。。。。。。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>





<blockquote>
<p>细节</p>
</blockquote>
<p><strong>主机可以写，从机不能写只能读</strong></p>
<p>主机中所有信息和数据都会自动被从机保存</p>
<ul>
<li>在没有配置哨兵的情况下，如果主机宕机了，从机就找不到主机了，但是它依旧保留着主机的信息，如果主机恢复了，从机依旧可以获取到主机写入的数据。</li>
<li>而当从机宕机了，主机依旧在写入数据，当从机恢复上线后，依旧会获取到主机这段时间写入的数据</li>
</ul>
<h3 id="6、复制原理"><a href="#6、复制原理" class="headerlink" title="6、复制原理"></a>6、复制原理</h3><p>Slave 启动成功连接到 master 后会发送一个 sync 同步命令</p>
<p>Master 接收到命令，会启动后台的存盘进程，同时收集所有接收到的用于修改数据集的命令，master 将传送这个文件给 slave，并完成一次完全同步。</p>
<ul>
<li>全量复制：slave 服务接收到数据库文件数据后，将其存盘并加载到内存中</li>
<li>增量复制：master 继续将新的所有收集到的修改命令依次传给 slave，完成同步</li>
</ul>
<p>但是只要是重新连接到 master，一次完全同步（全量复制）就会被自动执行。</p>
<p>考虑这种情况：</p>
<ul>
<li><p>原有模式  S - M - S</p>
</li>
<li><p>改变模式 M - S M - S</p>
</li>
<li><p>后一种情况，将从机设置为主机，但是查看信息它依旧是 从机，所以它还是只能读不能写，这时候情况发生了变化，主机写入的信息被从机读取，从机作为另一台从机的主机，又会将数据传递给另一台从机</p>
</li>
</ul>
<p>这<strong>一种模型</strong>：</p>
<ul>
<li>可以完成主从复制</li>
<li>当真正的 Master 宕机后，同时兼具 Master 和 Salve 身份的从机可以使用命令 <code>SLAVEOF no one</code>，将自己的身份变为 master，这样它的下面还是有从机的，如果真正的主机恢复上线了，就没有从机了，除非再次使用命令配置</li>
</ul>
<p><strong>SLAVEOF no one</strong> 适合任何模型</p>
<h3 id="7、哨兵模式（自动选举）"><a href="#7、哨兵模式（自动选举）" class="headerlink" title="7、哨兵模式（自动选举）"></a>7、<strong>哨兵模式</strong>（自动选举）</h3><p>当主机宕机后，从机中自动选举出新的主机</p>
<blockquote>
<p>概述</p>
</blockquote>
<p>主从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间服务不可用。这不是一种推荐的方式，更多时候，推荐优先使用哨兵模式。</p>
<p>Redis 从 2.8 开始正式提供了 Sentinel（哨兵）架构来解决这个问题。</p>
<p>能够在后台监控主机是否故障，如果故障了就<strong>根据投票数自动将从库转换为主库。</strong></p>
<p>哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立的进程，作为进程，他会独立运行。其原理是 <strong>哨兵通过发送命令，等待 Redis 服务器响应，从而监控运行的多个 Redis 实例</strong></p>
<p><img src="https://naivekyo.oss-cn-hangzhou.aliyuncs.com/blog%27image/Sentinel.png"></p>
<p>这里的哨兵有两个作用：</p>
<ul>
<li>通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器</li>
<li>当哨兵检测到 master 宕机，会自动将 slave 切换为 master，然后通过 <strong>发布订阅模式</strong> 通知其他的从服务器，修改配置文件，让它们切换主机</li>
</ul>
<p>然后一个哨兵进程对 Redis 服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了<strong>多哨兵模式</strong>。</p>
<h3 id="8、多哨兵模式"><a href="#8、多哨兵模式" class="headerlink" title="8、多哨兵模式"></a>8、多哨兵模式</h3><p>哨兵除了监控各个 Redis 服务器，各个哨兵之间也进行相互监控。</p>
<p>假设主服务器宕机，哨兵 1 先检测到这个结果，系统并不会马上进行 failover 过程，仅仅是 哨兵1 主观的认为主服务器不可用，这个现象称为 <strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵（随机）发起，进行 failover[故障转移] 操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为 <strong>客观下线</strong>。</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>目前的状态是一主二从。</p>
<p><strong>修改哨兵配置文件：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 指定监控对象</span>
<span class="token comment"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span>
sentinel monitor myredis <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">1</span> <span class="token comment"># 数字 1，代表只有当 1 个以上的哨兵认为主机出现了故障，那么就可以判定主机客观下线，开始从从机中选举主机</span>

sentinel down-after-milliseconds mymaster <span class="token number">60000</span>
sentinel failover-timeout mymaster <span class="token number">180000</span>
sentinel parallel-syncs mymaster <span class="token number">1</span>

sentinel monitor resque <span class="token number">192.168</span>.1.3 <span class="token number">6380</span> <span class="token number">4</span>
sentinel down-after-milliseconds resque <span class="token number">10000</span>
sentinel failover-timeout resque <span class="token number">180000</span>
sentinel parallel-syncs resque <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>启动哨兵：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-sentinel <span class="token punctuation">..</span>/etc/sentinel.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>如果 Master 节点断开了，Sentinel 会根据投票算法选出新的主机</p>
<p>而主机如果恢复上线，它会成为新的主机的从机</p>
<h3 id="9、哨兵模式优点和缺点"><a href="#9、哨兵模式优点和缺点" class="headerlink" title="9、哨兵模式优点和缺点"></a>9、哨兵模式优点和缺点</h3><p>优点：</p>
<ol>
<li>哨兵集群，基于主从复制模式，所有主从配置优点，它都有</li>
<li>主从可以切换，故障可以转移，系统的可用性会更好</li>
<li>哨兵模式就是主从模式的升级，更加健壮</li>
</ol>
<p>缺点：</p>
<ol>
<li>Redis 不好在线扩容，集群容量一旦达到上线，在线扩容就非常麻烦</li>
<li>实现哨兵模式的配置其实是非常麻烦的，里面有很多选择</li>
</ol>
<blockquote>
<p>哨兵模式的配置文件</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 哨兵实例运行端口，默认 26379</span>
port <span class="token number">26379</span>

<span class="token comment"># 哨兵 sentinel 的工作目录</span>
<span class="token function">dir</span> /tmp

<span class="token comment"># 哨兵 sentinel 监控的 redis 主节点 </span>
<span class="token comment"># quorum 配置多少个 sentinel 哨兵同一认为 master 主节点失联，那么这时就客观认为主节点失联了</span>
<span class="token comment"># sentinel mointer &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span>
sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span>

<span class="token comment"># 当在 Redis 实例中开启了 requirepass foobared 授权密码，这样所有连接 Redis 实例的客户端都要提供密码</span>
<span class="token comment"># 设置哨兵 sentinel 连接主从的密码，注意必须为主从设置一样的密码</span>
<span class="token comment"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span>
sentinel auth-pass mymaster <span class="token number">123456</span>

<span class="token comment"># 指定多少毫秒之后，主节点没有应答哨兵 sentinel，此时，哨兵主观认为主节点下线，默认 30 秒</span>
<span class="token comment"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span>
sentinel down-after-milliseconds <span class="token number">30000</span>

<span class="token comment"># 这个配置项指定了在发生 failover 主备切换时最多可以有多少个 slave 同时对新的 master 进行同步</span>
<span class="token comment"># 这个数字越小，完成 failover 所需的时间最长</span>
<span class="token comment"># 但是这个数字越大，意味着越多的 slave 因为 replication 而不可用</span>
<span class="token comment"># 可以通过将这个值设置为 1 来保证每次只有一个 slave 处于不能处理命令请求的状态</span>
<span class="token comment"># sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;</span>
sentinel parallel-syncs mymaster <span class="token number">1</span>

<span class="token comment"># 故障转移的超时时间 failover-timeout 可以用在以下方面</span>
<span class="token comment"># 1. 同一个 sentinel 对同一个 master 两次 failover 之间的时间间隔</span>
<span class="token comment"># 2. 当一个 slave 从一个错误的 master 那里同步数据开始计算时间。直到 slave 被纠正为向正确的 master 那里同步数据时。</span>
<span class="token comment"># 3. 当想要取消一个正在进行的 failover 所需要的时间</span>
<span class="token comment"># 4. 当进行 failover 时，配置所有 slaves 指向新的 master 所需的最大时间。不过，即使查过了这个时间，slaves 依然会被正确配置为指向 master，但是就不按 parallel-syncs 所配置的规则来了</span>
<span class="token comment"># 默认三分钟</span>
<span class="token comment"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span>
sentinel failover-timeout mymaster <span class="token number">180000</span>

<span class="token comment"># SCRIPTS EXECUTIOn</span>

<span class="token comment"># 配置当某一事件发生时所需要指向的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时可以发邮件通知相关人员</span>
<span class="token comment"># 对于脚本的执行结果有以下预测</span>
<span class="token comment"># 若脚本执行后返回 1，那么该脚本稍后将会被再次执行，重复次数目前默认为 0</span>
<span class="token comment"># 若脚本执行后返回 2，或者比 2 更高的一个返回值，脚本将不会重复执行</span>
<span class="token comment"># 如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值 1 时的行为相同</span>
<span class="token comment"># 一个脚本的最大执行时间为 60s，如果超过这个时间，脚本将会被一个 SIGKILL 信号终止，之后重新执行</span>

<span class="token comment"># 通知型脚本：当 sentinel 有任何警告级别的时间发生时（比如说 redis 实例的主观失效和客观失效等等），将会去调用这个脚本，这时一个脚本应该通过邮件，SMS 等方式通知系统管理员关于系统不正常运行的信息，调用该脚本时，传给脚本两个参数，一个是事件的类型，一个是事件的描述。如果 sentinel.conf 配置文件配置了这个脚本路径，那么必须保证这个脚本存在于这个路径中，并且是可执行的，否则 sentinel 无法正常启动</span>
<span class="token comment"># 通知脚本</span>
<span class="token comment"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span>
sentinel notification-script mymaster /var/redis/notify.sh

<span class="token comment"># 客户端重新配置主节点参数脚本</span>
<span class="token comment"># 当一个 master 由于 failover 而发生改变时，这个脚本将会调用，通知相关的客户端关于 master 地址已经发生改变的信息</span>
<span class="token comment"># 以下参数将会在调用脚本时传给脚本：</span>
<span class="token comment"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span>
<span class="token comment"># 目前 &lt;state&gt; 总是 "failover"</span>
<span class="token comment"># &lt;role&gt; 是 "leader" 或者 "observer" 中的一个</span>
<span class="token comment"># 参数 from-ip from-port to-ip to-port 是用来和旧的 master 和 新的 master(及旧的 slave) 通信的</span>
<span class="token comment"># 这个脚本应该是通用的，能够被多次调用，不是针对性的</span>
<span class="token comment"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span>
sentinel client-reconfig-script mymaster /var/redis/reconfig.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="十二、Redis-缓存穿透和雪崩（面试高频，工作常用）"><a href="#十二、Redis-缓存穿透和雪崩（面试高频，工作常用）" class="headerlink" title="十二、Redis 缓存穿透和雪崩（面试高频，工作常用）"></a>十二、Redis <strong>缓存穿透和雪崩</strong>（面试高频，工作常用）</h2><p>服务的高可用问题</p>
<p>Redis 缓存的使用，极大提升了应用程序的性能和效率，特别是数据查询方面，但同时，它也带来了一些问题，其中，最要害的问题，就是数据的一致性问题，从严格意义上讲，这个问题无解，如果对数据的一致性要求很高，那么就不要使用缓存。</p>
<p>另外一些典型的问题就是：缓存穿透、缓存雪崩和缓存击穿。目前，业界也有比较流行的解决方案。</p>
<h3 id="1、缓存穿透"><a href="#1、缓存穿透" class="headerlink" title="1、缓存穿透"></a>1、缓存穿透</h3><blockquote>
<p>概念</p>
</blockquote>
<p>缓存穿透的概念比较简单，用户想要查询一个数据，发现 redis 内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询，发现也没有，于是本次查询失败。当用户很多的时候，缓存都没有命中（比如说：秒杀场景），于是都去请求持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当于出现了缓存穿透。</p>
<p>流程：</p>
<ul>
<li>先到 Redis 查询数据：没有查到</li>
<li>再去 持久层数据库中查询：也没有查到</li>
<li>最终返回结果：没有查询到</li>
<li>可能用户会反复请求查询，结果每次都查不到，这就对数据库造成了很大的压力</li>
<li><strong>缓存穿透</strong></li>
</ul>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>布隆过滤器</strong></p>
<p>布隆过滤器是一种数据结构，对所有可能查询的参数以 hash 形式存储，在控制层先进行校验，不符合就丢弃，从而避免了对底层存储系统的查询压力：</p>
<p><img src="https://naivekyo.oss-cn-hangzhou.aliyuncs.com/blog%27image/bloomFilter.png"></p>
<p><strong>缓存空对象</strong></p>
<p>当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据库将会直接从缓存中获取，保护了后端数据源；</p>
<p>但是这个方法会存在两个问题：</p>
<ol>
<li>如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空指的键</li>
<li>即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致（如果这个值存储层有了，但是缓存层还是存的空值），这对于需要保持一致性的业务会有影响</li>
</ol>
<h3 id="2、缓存击穿"><a href="#2、缓存击穿" class="headerlink" title="2、缓存击穿"></a>2、缓存击穿</h3><p>微博热点</p>
<blockquote>
<p>概述</p>
</blockquote>
<p>注意和缓存击穿的区别，缓存击穿，是指一个 key 非常热门，客户端不停的请求这个 key，并发量非常高，大并发集中对这个点进行访问，当这个 key 在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。</p>
<p>当某个 key 在过期的瞬间，有大量的请求并发访问，这类数据一般都是热点数据，由于缓存过期，会同时访问数据库来查询最新的数据，并且回写缓存，会导致数据库瞬间压力过大</p>
<blockquote>
<p>解决方法</p>
</blockquote>
<p><strong>设置热点数据永不过期</strong></p>
<p>从缓存层来看，没有设置过期时间，所以不会出现热点 key 过期后产生的问题</p>
<p><strong>加互斥锁</strong></p>
<p>分布式锁：可以使用分布式锁，保证对每个 key 同时只有一个线程去查询后台服务，其他线程没有获得分布式锁的权限，因此只需等待即可。这种方式讲高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。</p>
<h3 id="3、缓存雪崩"><a href="#3、缓存雪崩" class="headerlink" title="3、缓存雪崩"></a>3、缓存雪崩</h3><blockquote>
<p>概念</p>
</blockquote>
<p>缓存雪崩，是指在某一个时间段，缓存集中过期失效。Redis 宕机</p>
<p>产生雪崩的原因之一，比如说双十一 11 点的时候将一批商品的信息写入缓存，设置过期时间为 1 小时，到了 12 点正好过期，这时候大量对这批商品信息的查询访问请求都落到了数据库头上，对于数据库而言，会产生周期性的压力波峰。于是所有请求都会到达存储层，存储层的调用量会暴增，造成存储层也会挂掉的情况。</p>
<p>其中过期，并不是非常致命，比较致命的缓存雪崩，是缓存服务器某个节点宕机或断网。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，这个时候，数据库也是可以顶住压力的。无非是对数据库产生周期性的压力而已。而缓存服务器节点的宕机，对数据库服务器造成的压力是不可预知的，很有可能瞬间把数据库压垮。</p>
<p>例子：双十一时，淘宝可以停掉一部分服务，保证主要服务可用</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>Redis 高可能</strong></p>
<p>这个思想的含义是，既然 redis 有可能挂掉，那我多设置几台 Redis，一台挂掉后其他的还可以继续工作，其实就是采用 Redis 集群。（异地多活）</p>
<p><strong>限流降级</strong></p>
<p>这个解决方案的思路是：在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个 key 只允许一个线程查询数据和写缓存，其他线程等待。</p>
<p><strong>数据预热</strong></p>
<p>数据加热的含义就是在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的 key，设置不同的过期时间，让缓存失效的时间点尽量均匀。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">NaiveKyo</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://naivekyo.github.io/2021/07/07/redis-intro/">https://naivekyo.github.io/2021/07/07/redis-intro/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">NaiveKyo</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Redis/">
                                    <span class="chip bg-color">Redis</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">OvO</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    
        <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://naivekyo.github.io/2021/07/07/redis-intro/';
        this.page.identifier = '/2021/07/07/redis-intro/';
        this.page.title = 'Redis_Intro';
    };
    let disqus_shortname = 'https-naivekyo-github-io';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/07/07/nginx-intro/">
                    <div class="card-image">
                        
                        <img src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/medias/featureimages/5.jpg" class="responsive-img" alt="Nginx_Intro">
                        
                        <span class="card-title">Nginx_Intro</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            学习 Nginx 知识，了解其主要作用和常用命令。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Nginx/" class="post-category">
                                    Nginx
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Nginx/">
                        <span class="chip bg-color">Nginx</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/07/springaop-aspectj-intro/">
                    <div class="card-image">
                        
                        <img src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/medias/featureimages/1.jpg" class="responsive-img" alt="SpringAop AspectJ Intro">
                        
                        <span class="card-title">SpringAop AspectJ Intro</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            学习 Spring 中的 AOP 使用方法，以及了解 AspectJ
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring/" class="post-category">
                                    Spring
                                </a>
                            
                            <a href="/categories/Spring/AOP/" class="post-category">
                                    AOP
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spring/">
                        <span class="chip bg-color">Spring</span>
                    </a>
                    
                    <a href="/tags/Aop/">
                        <span class="chip bg-color">Aop</span>
                    </a>
                    
                    <a href="/tags/AspectJ/">
                        <span class="chip bg-color">AspectJ</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="song"
                   id="27969834"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <!-- <span id="year">2021</span> -->
            <a href="/about" target="_blank">NaiveKyo</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
		
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "7";
                    var startDate = "6";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">














</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="https://cdn.jsdelivr.net/gh/NaiveKyo/CDN/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
